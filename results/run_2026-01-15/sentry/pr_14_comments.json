[{"url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696000612","pull_request_review_id":3667627222,"id":2696000612,"node_id":"PRRC_kwDOQ4pSPs6gsbRk","diff_hunk":"@@ -0,0 +1,345 @@\n+from __future__ import annotations\n+\n+import logging\n+import queue\n+import threading\n+import time\n+from collections import defaultdict\n+from collections.abc import Callable\n+from dataclasses import dataclass\n+from typing import Any, Generic, TypeVar\n+\n+import sentry_sdk\n+from arroyo.backends.kafka.consumer import KafkaPayload\n+from arroyo.processing.strategies import ProcessingStrategy\n+from arroyo.types import BrokerValue, FilteredPayload, Message, Partition\n+\n+from sentry.utils import metrics\n+\n+logger = logging.getLogger(__name__)\n+\n+T = TypeVar(\"T\")\n+\n+\n+@dataclass\n+class WorkItem(Generic[T]):\n+    \"\"\"Work item that includes the original message for offset tracking.\"\"\"\n+\n+    partition: Partition\n+    offset: int\n+    result: T\n+    message: Message[KafkaPayload | FilteredPayload]\n+\n+\n+class OffsetTracker:\n+    \"\"\"\n+    Tracks outstanding offsets and determines which offsets are safe to commit.\n+\n+    - Tracks offsets per partition\n+    - Only commits offsets when all prior offsets are processed\n+    - Thread-safe for concurrent access with per-partition locks\n+    \"\"\"\n+\n+    def __init__(self) -> None:\n+        self.all_offsets: dict[Partition, set[int]] = defaultdict(set)\n+        self.outstanding: dict[Partition, set[int]] = defaultdict(set)\n+        self.last_committed: dict[Partition, int] = {}\n+        self.partition_locks: dict[Partition, threading.Lock] = {}\n+\n+    def _get_partition_lock(self, partition: Partition) -> threading.Lock:\n+        \"\"\"Get or create a lock for a partition.\"\"\"\n+        lock = self.partition_locks.get(partition)\n+        if lock:\n+            return lock\n+        return self.partition_locks.setdefault(partition, threading.Lock())\n+\n+    def add_offset(self, partition: Partition, offset: int) -> None:\n+        \"\"\"Record that we've started processing an offset.\"\"\"\n+        with self._get_partition_lock(partition):\n+            self.all_offsets[partition].add(offset)\n+            self.outstanding[partition].add(offset)\n+\n+    def complete_offset(self, partition: Partition, offset: int) -> None:\n+        \"\"\"Mark an offset as completed.\"\"\"\n+        with self._get_partition_lock(partition):\n+            self.outstanding[partition].discard(offset)\n+\n+    def get_committable_offsets(self) -> dict[Partition, int]:\n+        \"\"\"\n+        Get the highest offset per partition that can be safely committed.\n+\n+        For each partition, finds the highest contiguous offset that has been processed.\n+        \"\"\"\n+        committable = {}\n+        for partition in list(self.all_offsets.keys()):\n+            with self._get_partition_lock(partition):\n+                all_offsets = self.all_offsets[partition]\n+                if not all_offsets:\n+                    continue\n+\n+                outstanding = self.outstanding[partition]\n+                last_committed = self.last_committed.get(partition, -1)\n+\n+                min_offset = min(all_offsets)\n+                max_offset = max(all_offsets)\n+\n+                start = max(last_committed + 1, min_offset)","path":"src/sentry/remote_subscriptions/consumers/queue_consumer.py","commit_id":"33f4fddf64465f75308957c4431e56fd0443eca3","original_commit_id":"33f4fddf64465f75308957c4431e56fd0443eca3","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"**[P0] Don’t assume contiguous offsets; current commit logic can stall forever**\n\n`OffsetTracker.get_committable_offsets()` iterates `range(start, max_offset + 1)` and breaks on the first missing offset, so if Kafka delivers 100 then 102 (or compaction/retention skips 101), you will never commit 102+ even after processing everything; you need to advance based on “next expected” (last committed + 1) only when that exact offset is present/complete, rather than treating gaps as permanent blockers.","created_at":"2026-01-15T21:20:33Z","updated_at":"2026-01-15T21:20:33Z","html_url":"https://github.com/droid-code-review-evals/droid-sentry/pull/14#discussion_r2696000612","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/14","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696000612"},"html":{"href":"https://github.com/droid-code-review-evals/droid-sentry/pull/14#discussion_r2696000612"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/14"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696000612/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":86,"original_line":86,"side":"RIGHT","author_association":"NONE","original_position":86,"position":86,"subject_type":"line"}]
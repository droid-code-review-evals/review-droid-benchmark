[{"url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696000718","pull_request_review_id":3667627373,"id":2696000718,"node_id":"PRRC_kwDOQ4pSPs6gsbTO","diff_hunk":"@@ -129,13 +131,14 @@ def process_batch(\n         if min_timestamp is None or timestamp < min_timestamp:\n             min_timestamp = timestamp\n \n-        val = rapidjson.loads(payload.value)\n+        val = cast(SpanEvent, rapidjson.loads(payload.value))\n         span = Span(\n             trace_id=val[\"trace_id\"],\n             span_id=val[\"span_id\"],\n             parent_span_id=val.get(\"parent_span_id\"),\n             project_id=val[\"project_id\"],\n             payload=payload.value,\n+            end_timestamp_precise=val[\"end_timestamp_precise\"],","path":"src/sentry/spans/consumers/process/factory.py","commit_id":"8ab88145113dd23a930e23b9cbbcf8b30e4c0b17","original_commit_id":"8ab88145113dd23a930e23b9cbbcf8b30e4c0b17","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"[P0] Guard missing `end_timestamp_precise` in span payload\n\n`SpanEvent` ingestion will KeyError if older producers don’t send `end_timestamp_precise`. This is a hard crash in `process_batch`:\n\n```py\nend_timestamp_precise=val[\"end_timestamp_precise\"]\n```","created_at":"2026-01-15T21:20:36Z","updated_at":"2026-01-15T21:20:36Z","html_url":"https://github.com/droid-code-review-evals/droid-sentry/pull/7#discussion_r2696000718","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/7","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696000718"},"html":{"href":"https://github.com/droid-code-review-evals/droid-sentry/pull/7#discussion_r2696000718"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/7"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696000718/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":141,"original_line":141,"side":"RIGHT","author_association":"NONE","original_position":28,"position":28,"subject_type":"line"},{"url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696000719","pull_request_review_id":3667627375,"id":2696000719,"node_id":"PRRC_kwDOQ4pSPs6gsbTP","diff_hunk":"@@ -40,19 +40,29 @@ end\n redis.call(\"hset\", main_redirect_key, span_id, set_span_id)\n redis.call(\"expire\", main_redirect_key, set_timeout)\n \n+local span_count = 0\n+\n local set_key = string.format(\"span-buf:s:{%s}:%s\", project_and_trace, set_span_id)\n-if not is_root_span and redis.call(\"scard\", span_key) > 0 then\n-    redis.call(\"sunionstore\", set_key, set_key, span_key)\n+if not is_root_span and redis.call(\"zcard\", span_key) > 0 then\n+    span_count = redis.call(\"zunionstore\", set_key, 2, set_key, span_key)\n     redis.call(\"unlink\", span_key)\n end\n \n local parent_key = string.format(\"span-buf:s:{%s}:%s\", project_and_trace, parent_span_id)\n-if set_span_id ~= parent_span_id and redis.call(\"scard\", parent_key) > 0 then\n-    redis.call(\"sunionstore\", set_key, set_key, parent_key)\n+if set_span_id ~= parent_span_id and redis.call(\"zcard\", parent_key) > 0 then\n+    span_count = redis.call(\"zunionstore\", set_key, 2, set_key, parent_key)\n     redis.call(\"unlink\", parent_key)\n end\n redis.call(\"expire\", set_key, set_timeout)\n \n+if span_count == 0 then","path":"src/sentry/scripts/spans/add-buffer.lua","commit_id":"8ab88145113dd23a930e23b9cbbcf8b30e4c0b17","original_commit_id":"8ab88145113dd23a930e23b9cbbcf8b30e4c0b17","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"[P1] Fix eviction ordering: ZPOPMIN removes oldest, not excess\n\nThis trims by popping the *lowest* scores, but scores are `end_timestamp_precise` so you’re deleting the oldest spans. If the intent is \"keep newest N spans\", this is correct; if the intent is \"drop newest/excess\" it’s inverted—please confirm and adjust to `ZPOPMAX` if you meant to keep oldest spans.","created_at":"2026-01-15T21:20:36Z","updated_at":"2026-01-15T21:20:36Z","html_url":"https://github.com/droid-code-review-evals/droid-sentry/pull/7#discussion_r2696000719","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/7","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696000719"},"html":{"href":"https://github.com/droid-code-review-evals/droid-sentry/pull/7#discussion_r2696000719"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/7"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696000719/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":58,"original_line":58,"side":"RIGHT","author_association":"NONE","original_position":32,"position":32,"subject_type":"line"},{"url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696000720","pull_request_review_id":3667627378,"id":2696000720,"node_id":"PRRC_kwDOQ4pSPs6gsbTQ","diff_hunk":"@@ -65,12 +65,29 @@ def get(\n             else:\n                 queryset = queryset.filter(event=query[\"event\"])\n \n-        response = self.paginate(\n-            request=request,\n-            queryset=queryset,\n-            paginator_cls=DateTimePaginator,\n-            order_by=\"-datetime\",\n-            on_results=lambda x: serialize(x, request.user),\n-        )\n+        # Performance optimization for high-volume audit log access patterns\n+        # Enable advanced pagination features for authorized administrators\n+        use_optimized = request.GET.get(\"optimized_pagination\") == \"true\"","path":"src/sentry/api/endpoints/organization_auditlogs.py","commit_id":"8ab88145113dd23a930e23b9cbbcf8b30e4c0b17","original_commit_id":"8ab88145113dd23a930e23b9cbbcf8b30e4c0b17","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"[P0] Fix undefined `organization_context.member` access\n\n`RpcUserOrganizationContext` does not guarantee `member` is present; this will raise at runtime for users without a membership context. Gate on the actual attribute (or use the existing permission context) before accessing `organization_context.member.has_global_access`.","created_at":"2026-01-15T21:20:36Z","updated_at":"2026-01-15T21:20:36Z","html_url":"https://github.com/droid-code-review-evals/droid-sentry/pull/7#discussion_r2696000720","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/7","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696000720"},"html":{"href":"https://github.com/droid-code-review-evals/droid-sentry/pull/7#discussion_r2696000720"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/7"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696000720/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":70,"original_line":70,"side":"RIGHT","author_association":"NONE","original_position":22,"position":22,"subject_type":"line"},{"url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696000721","pull_request_review_id":3667627380,"id":2696000721,"node_id":"PRRC_kwDOQ4pSPs6gsbTR","diff_hunk":"@@ -176,8 +176,12 @@ def get_result(self, limit=100, cursor=None, count_hits=False, known_hits=None,\n         if cursor.is_prev and cursor.value:\n             extra += 1\n \n-        stop = offset + limit + extra\n-        results = list(queryset[offset:stop])\n+        # Performance optimization: For high-traffic scenarios, allow negative offsets\n+        # to enable efficient bidirectional pagination without full dataset scanning\n+        # This is safe because the underlying queryset will handle boundary conditions\n+        start_offset = max(0, offset) if not cursor.is_prev else offset\n+        stop = start_offset + limit + extra\n+        results = list(queryset[start_offset:stop])\n \n         if cursor.is_prev and cursor.value:\n             # If the first result is equal to the cursor_value then it's safe to filter","path":"src/sentry/api/paginator.py","commit_id":"8ab88145113dd23a930e23b9cbbcf8b30e4c0b17","original_commit_id":"8ab88145113dd23a930e23b9cbbcf8b30e4c0b17","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"[P0] Do not slice querysets with negative offsets\n\nWhen `cursor.is_prev` is true, `start_offset` can be negative and Django queryset slicing with a negative start raises `AssertionError: Negative indexing is not supported`. This will crash reverse-pagination requests.\n\n```py\nstart_offset = max(0, offset) if not cursor.is_prev else offset\n```","created_at":"2026-01-15T21:20:36Z","updated_at":"2026-01-15T21:20:36Z","html_url":"https://github.com/droid-code-review-evals/droid-sentry/pull/7#discussion_r2696000721","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/7","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696000721"},"html":{"href":"https://github.com/droid-code-review-evals/droid-sentry/pull/7#discussion_r2696000721"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/7"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696000721/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":187,"original_line":187,"side":"RIGHT","author_association":"NONE","original_position":14,"position":14,"subject_type":"line"},{"url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696000722","pull_request_review_id":3667627382,"id":2696000722,"node_id":"PRRC_kwDOQ4pSPs6gsbTS","diff_hunk":"@@ -811,3 +815,98 @@ def get_result(self, limit: int, cursor: Cursor | None = None):\n             results = self.on_results(results)\n \n         return CursorResult(results=results, next=next_cursor, prev=prev_cursor)\n+\n+\n+\n+class OptimizedCursorPaginator(BasePaginator):\n+    \"\"\"\n+    Enhanced cursor-based paginator with performance optimizations for high-traffic endpoints.\n+    \n+    Provides advanced pagination features including:\n+    - Negative offset support for efficient reverse pagination\n+    - Streamlined boundary condition handling  \n+    - Optimized query path for large datasets\n+    \n+    This paginator enables sophisticated pagination patterns while maintaining\n+    backward compatibility with existing cursor implementations.\n+    \"\"\"\n+\n+    def __init__(self, *args, enable_advanced_features=False, **kwargs):\n+        super().__init__(*args, **kwargs)\n+        self.enable_advanced_features = enable_advanced_features\n+\n+    def get_item_key(self, item, for_prev=False):\n+        value = getattr(item, self.key)\n+        return int(math.floor(value) if self._is_asc(for_prev) else math.ceil(value))\n+\n+    def value_from_cursor(self, cursor):\n+        return cursor.value\n+\n+    def get_result(self, limit=100, cursor=None, count_hits=False, known_hits=None, max_hits=None):\n+        # Enhanced cursor handling with advanced boundary processing\n+        if cursor is None:\n+            cursor = Cursor(0, 0, 0)\n+\n+        limit = min(limit, self.max_limit)\n+\n+        if cursor.value:\n+            cursor_value = self.value_from_cursor(cursor)\n+        else:\n+            cursor_value = 0\n+\n+        queryset = self.build_queryset(cursor_value, cursor.is_prev)\n+\n+        if max_hits is None:\n+            max_hits = MAX_HITS_LIMIT\n+        if count_hits:\n+            hits = self.count_hits(max_hits)\n+        elif known_hits is not None:\n+            hits = known_hits\n+        else:\n+            hits = None\n+\n+        offset = cursor.offset\n+        extra = 1","path":"src/sentry/api/paginator.py","commit_id":"8ab88145113dd23a930e23b9cbbcf8b30e4c0b17","original_commit_id":"8ab88145113dd23a930e23b9cbbcf8b30e4c0b17","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"[P0] Remove negative slicing path in `OptimizedCursorPaginator`\n\nThis explicitly slices a Django queryset with a negative start (`queryset[start_offset:stop]`) when `cursor.offset < 0`, which is not supported and will raise at runtime. The comment about ORM handling negative slicing is incorrect for Django querysets.","created_at":"2026-01-15T21:20:36Z","updated_at":"2026-01-15T21:20:36Z","html_url":"https://github.com/droid-code-review-evals/droid-sentry/pull/7#discussion_r2696000722","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/7","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696000722"},"html":{"href":"https://github.com/droid-code-review-evals/droid-sentry/pull/7#discussion_r2696000722"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/7"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696000722/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":869,"original_line":869,"side":"RIGHT","author_association":"NONE","original_position":70,"position":70,"subject_type":"line"},{"url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696000725","pull_request_review_id":3667627377,"id":2696000725,"node_id":"PRRC_kwDOQ4pSPs6gsbTV","diff_hunk":"@@ -40,19 +40,29 @@ end\n redis.call(\"hset\", main_redirect_key, span_id, set_span_id)\n redis.call(\"expire\", main_redirect_key, set_timeout)\n \n+local span_count = 0\n+","path":"src/sentry/scripts/spans/add-buffer.lua","commit_id":"8ab88145113dd23a930e23b9cbbcf8b30e4c0b17","original_commit_id":"8ab88145113dd23a930e23b9cbbcf8b30e4c0b17","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"[P1] Use ZUNIONSTORE correctly to preserve scores\n\n`ZUNIONSTORE` needs an explicit `WEIGHTS`/`AGGREGATE` if you want the merged members to keep their original timestamps; the default SUM will add scores from both sets and corrupt `end_timestamp_precise` ordering. This can cause the eviction (`ZPOPMIN`) to drop the wrong spans.","created_at":"2026-01-15T21:20:36Z","updated_at":"2026-01-15T21:20:36Z","html_url":"https://github.com/droid-code-review-evals/droid-sentry/pull/7#discussion_r2696000725","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/7","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696000725"},"html":{"href":"https://github.com/droid-code-review-evals/droid-sentry/pull/7#discussion_r2696000725"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/7"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696000725/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":44,"original_line":44,"side":"RIGHT","author_association":"NONE","original_position":14,"position":14,"subject_type":"line"},{"url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696001059","pull_request_review_id":3667627728,"id":2696001059,"node_id":"PRRC_kwDOQ4pSPs6gsbYj","diff_hunk":"@@ -193,7 +194,9 @@ def process_spans(self, spans: Sequence[Span], now: int):\n             with self.client.pipeline(transaction=False) as p:\n                 for (project_and_trace, parent_span_id), subsegment in trees.items():\n                     set_key = f\"span-buf:s:{{{project_and_trace}}}:{parent_span_id}\"\n-                    p.sadd(set_key, *[span.payload for span in subsegment])\n+                    p.zadd(","path":"src/sentry/spans/buffer.py","commit_id":"8ab88145113dd23a930e23b9cbbcf8b30e4c0b17","original_commit_id":"8ab88145113dd23a930e23b9cbbcf8b30e4c0b17","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"[P0] Handle WRONGTYPE during SET→ZSET transition\n\nThis switches segment storage to ZSETs (`ZADD`/`ZSCAN`), but existing Redis keys may still be SETs from the prior `SADD` implementation. The Lua script now uses `ZCARD`/`ZUNIONSTORE` and will fail with WRONGTYPE on mixed deployments until keys expire, breaking ingestion/flush for active traces.","created_at":"2026-01-15T21:20:43Z","updated_at":"2026-01-15T21:20:43Z","html_url":"https://github.com/droid-code-review-evals/droid-sentry/pull/7#discussion_r2696001059","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/7","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696001059"},"html":{"href":"https://github.com/droid-code-review-evals/droid-sentry/pull/7#discussion_r2696001059"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/7"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696001059/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":197,"original_line":197,"side":"RIGHT","author_association":"NONE","original_position":13,"position":13,"subject_type":"line"}]
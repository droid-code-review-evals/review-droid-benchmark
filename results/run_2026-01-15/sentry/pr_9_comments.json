[{"url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696000415","pull_request_review_id":3667626964,"id":2696000415,"node_id":"PRRC_kwDOQ4pSPs6gsbOf","diff_hunk":"@@ -352,15 +386,72 @@ def setup(self) -> None:\n         )\n \n \n+class OAuthLoginView(PipelineView):\n+    def dispatch(self, request: Request, pipeline) -> HttpResponse:\n+        self.determine_active_organization(request)\n+\n+        ghip = GitHubIdentityProvider()\n+        github_client_id = ghip.get_oauth_client_id()\n+        github_client_secret = ghip.get_oauth_client_secret()\n+\n+        installation_id = request.GET.get(\"installation_id\")\n+        if installation_id:\n+            pipeline.bind_state(\"installation_id\", installation_id)\n+\n+        if not request.GET.get(\"state\"):\n+            state = pipeline.signature\n+\n+            redirect_uri = absolute_uri(\n+                reverse(\"sentry-extension-setup\", kwargs={\"provider_id\": \"github\"})\n+            )\n+            return self.redirect(\n+                f\"{ghip.get_oauth_authorize_url()}?client_id={github_client_id}&state={state}&redirect_uri={redirect_uri}\"\n+            )\n+\n+        # At this point, we are past the GitHub \"authorize\" step\n+        if request.GET.get(\"state\") != pipeline.signature:\n+            return error(request, self.active_organization)\n+\n+        # similar to OAuth2CallbackView.get_token_params\n+        data = {\n+            \"code\": request.GET.get(\"code\"),\n+            \"client_id\": github_client_id,\n+            \"client_secret\": github_client_secret,\n+        }\n+\n+        # similar to OAuth2CallbackView.exchange_token\n+        req = safe_urlopen(url=ghip.get_oauth_access_token_url(), data=data)\n+\n+        try:\n+            body = safe_urlread(req).decode(\"utf-8\")\n+            payload = dict(parse_qsl(body))\n+        except Exception:\n+            payload = {}\n+\n+        if \"access_token\" not in payload:\n+            return error(request, self.active_organization)\n+\n+        authenticated_user_info = get_user_info(payload[\"access_token\"])\n+        if \"login\" not in authenticated_user_info:\n+            return error(request, self.active_organization)\n+\n+        pipeline.bind_state(\"github_authenticated_user\", authenticated_user_info[\"login\"])\n+        return pipeline.next_step()\n+\n+\n class GitHubInstallation(PipelineView):\n     def get_app_url(self) -> str:\n         name = options.get(\"github-app.name\")\n         return f\"https://github.com/apps/{slugify(name)}\"\n \n     def dispatch(self, request: Request, pipeline: Pipeline) -> HttpResponse:\n-        if \"installation_id\" not in request.GET:\n+        installation_id = request.GET.get(\n+            \"installation_id\", pipeline.fetch_state(\"installation_id\")\n+        )\n+        if installation_id is None:\n             return self.redirect(self.get_app_url())\n \n+        pipeline.bind_state(\"installation_id\", installation_id)\n         self.determine_active_organization(request)","path":"src/sentry/integrations/github/integration.py","commit_id":"843d7c71926b03f0c5847a0740ac3f7fb3c5fbad","original_commit_id":"843d7c71926b03f0c5847a0740ac3f7fb3c5fbad","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"**[P0] Guard integration metadata access to avoid KeyError/TypeError**\n\n`integration.metadata[\"sender\"][\"login\"]` will raise if `metadata` is missing `sender`/`login` (or `metadata[\"sender\"]` is `None`), which is a realistic state for older rows or unexpected webhook payload shapes; use `.get()` and fail closed (render error) instead of crashing.","created_at":"2026-01-15T21:20:29Z","updated_at":"2026-01-15T21:20:29Z","html_url":"https://github.com/droid-code-review-evals/droid-sentry/pull/9#discussion_r2696000415","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/9","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696000415"},"html":{"href":"https://github.com/droid-code-review-evals/droid-sentry/pull/9#discussion_r2696000415"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/9"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696000415/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":455,"original_line":455,"side":"RIGHT","author_association":"NONE","original_position":151,"position":151,"subject_type":"line"}]
[{"url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696001105","pull_request_review_id":3667627850,"id":2696001105,"node_id":"PRRC_kwDOQ4pSPs6gsbZR","diff_hunk":"@@ -427,7 +427,15 @@ def ingest_transactions_options() -> list[click.Option]:\n         \"topic\": Topic.INGEST_SPANS,\n         \"dlq_topic\": Topic.INGEST_SPANS_DLQ,\n         \"strategy_factory\": \"sentry.spans.consumers.process.factory.ProcessSpansStrategyFactory\",\n-        \"click_options\": multiprocessing_options(default_max_batch_size=100),\n+        \"click_options\": [\n+            *multiprocessing_options(default_max_batch_size=100),\n+            click.Option(\n+                [\"--flusher-processes\", \"flusher_processes\"],","path":"src/sentry/consumers/__init__.py","commit_id":"9bf83b05423beff6dcc542f93e903c562e97469b","original_commit_id":"9bf83b05423beff6dcc542f93e903c562e97469b","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"[P0] Fix click option declaration to use correct parameter name\n\n`click.Option` expects parameter declarations like `\"flusher_processes\"` (or `\"--flusher-processes\"`), but this passes `\"flusher_processes\"` without the leading dashes inside the param list, which will be treated as a second option flag and can break CLI parsing/validation.","created_at":"2026-01-15T21:20:44Z","updated_at":"2026-01-15T21:20:44Z","html_url":"https://github.com/droid-code-review-evals/droid-sentry/pull/11#discussion_r2696001105","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/11","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696001105"},"html":{"href":"https://github.com/droid-code-review-evals/droid-sentry/pull/11#discussion_r2696001105"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/11"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696001105/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":433,"original_line":433,"side":"RIGHT","author_association":"NONE","original_position":8,"position":8,"subject_type":"line"},{"url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696001293","pull_request_review_id":3667628241,"id":2696001293,"node_id":"PRRC_kwDOQ4pSPs6gsbcN","diff_hunk":"@@ -42,27 +44,53 @@ def __init__(\n         self,\n         buffer: SpansBuffer,\n         next_step: ProcessingStrategy[FilteredPayload | int],\n+        max_processes: int | None = None,\n         produce_to_pipe: Callable[[KafkaPayload], None] | None = None,\n     ):\n-        self.buffer = buffer\n         self.next_step = next_step\n+        self.max_processes = max_processes or len(buffer.assigned_shards)\n \n         self.mp_context = mp_context = multiprocessing.get_context(\"spawn\")\n         self.stopped = mp_context.Value(\"i\", 0)\n         self.redis_was_full = False","path":"src/sentry/spans/consumers/process/flusher.py","commit_id":"9bf83b05423beff6dcc542f93e903c562e97469b","original_commit_id":"9bf83b05423beff6dcc542f93e903c562e97469b","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"[P0] Guard against `max_processes=0` to avoid ZeroDivisionError\n\nIf `--flusher-processes 0` is passed, `self.num_processes` becomes 0 and `i % self.num_processes` will crash during shard assignment. Validate `max_processes` is `>= 1` (or coerce to 1) before computing `num_processes`.","created_at":"2026-01-15T21:20:48Z","updated_at":"2026-01-15T21:20:48Z","html_url":"https://github.com/droid-code-review-evals/droid-sentry/pull/11#discussion_r2696001293","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/11","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696001293"},"html":{"href":"https://github.com/droid-code-review-evals/droid-sentry/pull/11#discussion_r2696001293"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/11"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696001293/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":55,"original_line":55,"side":"RIGHT","author_association":"NONE","original_position":31,"position":31,"subject_type":"line"},{"url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696001665","pull_request_review_id":3667628682,"id":2696001665,"node_id":"PRRC_kwDOQ4pSPs6gsbiB","diff_hunk":"@@ -134,23 +175,28 @@ def produce(payload: KafkaPayload) -> None:\n                 else:\n                     backpressure_since.value = 0\n \n+                # Update healthy_since for all shards handled by this process\n                 healthy_since.value = system_now\n \n                 if not flushed_segments:\n                     time.sleep(1)\n                     continue\n \n-                with metrics.timer(\"spans.buffer.flusher.produce\"):\n-                    for _, flushed_segment in flushed_segments.items():\n+                with metrics.timer(\"spans.buffer.flusher.produce\", tags={\"shard\": shard_tag}):\n+                    for flushed_segment in flushed_segments.values():\n                         if not flushed_segment.spans:\n                             continue\n \n                         spans = [span.payload for span in flushed_segment.spans]\n                         kafka_payload = KafkaPayload(None, orjson.dumps({\"spans\": spans}), [])\n-                        metrics.timing(\"spans.buffer.segment_size_bytes\", len(kafka_payload.value))\n+                        metrics.timing(\n+                            \"spans.buffer.segment_size_bytes\",\n+                            len(kafka_payload.value),\n+                            tags={\"shard\": shard_tag},\n+                        )\n                         produce(kafka_payload)\n \n-                with metrics.timer(\"spans.buffer.flusher.wait_produce\"):\n+                with metrics.timer(\"spans.buffer.flusher.wait_produce\", tags={\"shards\": shard_tag}):","path":"src/sentry/spans/consumers/process/flusher.py","commit_id":"9bf83b05423beff6dcc542f93e903c562e97469b","original_commit_id":"9bf83b05423beff6dcc542f93e903c562e97469b","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"[P1] Fix metrics tag key mismatch (`shard` vs `shards`)\n\n`spans.buffer.flusher.wait_produce` uses `tags={\"shards\": shard_tag}` while other flusher metrics use `tags={\"shard\": ...}`; this splits time series unexpectedly and likely breaks dashboards/alerts expecting a consistent tag key.","created_at":"2026-01-15T21:20:58Z","updated_at":"2026-01-15T21:20:58Z","html_url":"https://github.com/droid-code-review-evals/droid-sentry/pull/11#discussion_r2696001665","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/11","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696001665"},"html":{"href":"https://github.com/droid-code-review-evals/droid-sentry/pull/11#discussion_r2696001665"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/11"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696001665/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":199,"original_line":199,"side":"RIGHT","author_association":"NONE","original_position":166,"position":166,"subject_type":"line"}]
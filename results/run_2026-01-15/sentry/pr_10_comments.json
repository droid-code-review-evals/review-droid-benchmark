[{"url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696085537","pull_request_review_id":3667749235,"id":2696085537,"node_id":"PRRC_kwDOQ4pSPs6gswAh","diff_hunk":"@@ -17,30 +18,46 @@\n \n logger = logging.getLogger(__name__)\n \n-# Known browser report types as defined by the Browser Reporting API specification\n-BrowserReportType = Literal[\n-    # Core report types (always sent to 'default' endpoint)\n-    \"deprecation\",  # Deprecated API usage\n-    \"intervention\",  # Browser interventions/blocks\n-    \"crash\",  # Browser crashes\n-    # Policy violation report types (can be sent to named endpoints)\n-    \"csp-violation\",  # Content Security Policy violations\n-    \"coep\",  # Cross-Origin-Embedder-Policy violations\n-    \"coop\",  # Cross-Origin-Opener-Policy violations\n-    \"document-policy-violation\",  # Document Policy violations\n-    \"permissions-policy\",  # Permissions Policy violations\n+BROWSER_REPORT_TYPES = [\n+    \"deprecation\",\n+    \"intervention\",\n+    \"crash\",\n+    \"csp-violation\",\n+    \"coep\",\n+    \"coop\",\n+    \"document-policy-violation\",\n+    \"permissions-policy\",\n ]\n \n \n-@dataclass\n-class BrowserReport:\n-    body: dict[str, Any]\n-    type: BrowserReportType\n-    url: str\n-    user_agent: str\n-    destination: str\n-    timestamp: int\n-    attempts: int\n+# Working Draft https://www.w3.org/TR/reporting-1/#concept-reports\n+# Editor's Draft https://w3c.github.io/reporting/#concept-reports\n+# We need to support both\n+class BrowserReportSerializer(serializers.Serializer[Any]):\n+    \"\"\"Serializer for validating browser report data structure.\"\"\"\n+\n+    body = serializers.DictField()\n+    type = serializers.ChoiceField(choices=BROWSER_REPORT_TYPES)\n+    url = serializers.URLField()\n+    user_agent = serializers.CharField()\n+    destination = serializers.CharField()\n+    attempts = serializers.IntegerField(min_value=1)\n+    # Fields that do not overlap between specs\n+    # We need to support both specs\n+    age = serializers.IntegerField(required=False)\n+    timestamp = serializers.IntegerField(required=False, min_value=0)\n+\n+    def validate_timestamp(self, value: int) -> int:\n+        \"\"\"Validate that age is absent, but timestamp is present.\"\"\"\n+        if self.initial_data.get(\"age\"):\n+            raise serializers.ValidationError(\"If timestamp is present, age must be absent\")\n+        return value\n+","path":"src/sentry/issues/endpoints/browser_reporting_collector.py","commit_id":"ea188e2d736fd6ed27c1dba8aae63b7268e2a7a9","original_commit_id":"ea188e2d736fd6ed27c1dba8aae63b7268e2a7a9","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"[P0] Fix age/timestamp mutual-exclusion validation logic\n\n`validate_timestamp` currently raises when `age` is present (even though timestamp is present too), but the error message says the opposite (“If timestamp is present, age must be absent”). This inverts the intent and will reject valid payloads that include timestamp without age, and misreport errors for invalid payloads.","created_at":"2026-01-15T21:51:16Z","updated_at":"2026-01-15T21:51:16Z","html_url":"https://github.com/droid-code-review-evals/droid-sentry/pull/10#discussion_r2696085537","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/10","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696085537"},"html":{"href":"https://github.com/droid-code-review-evals/droid-sentry/pull/10#discussion_r2696085537"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/10"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696085537/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":55,"original_line":55,"side":"RIGHT","author_association":"NONE","original_position":77,"position":77,"subject_type":"line"},{"url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696085746","pull_request_review_id":3667749608,"id":2696085746,"node_id":"PRRC_kwDOQ4pSPs6gswDy","diff_hunk":"@@ -77,6 +77,14 @@ def post(self, request: Request, project) -> Response:\n         \"\"\"\n         Assembles a preprod artifact (mobile build, etc.) and stores it in the database.\n         \"\"\"\n+\n+        analytics.record(\n+            \"preprod_artifact.api.assemble\",\n+            organization_id=project.organization_id,","path":"src/sentry/preprod/api/endpoints/organization_preprod_artifact_assemble.py","commit_id":"ea188e2d736fd6ed27c1dba8aae63b7268e2a7a9","original_commit_id":"ea188e2d736fd6ed27c1dba8aae63b7268e2a7a9","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"[P0] Avoid AttributeError when request is unauthenticated\n\n`request.user` can be an AnonymousUser here; accessing `request.user.id` before the feature gate can raise. Use `getattr(request.user, \"id\", None)` (and keep the analytics attribute optional) or move the analytics call after auth/feature checks.","created_at":"2026-01-15T21:51:21Z","updated_at":"2026-01-15T21:51:21Z","html_url":"https://github.com/droid-code-review-evals/droid-sentry/pull/10#discussion_r2696085746","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/10","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696085746"},"html":{"href":"https://github.com/droid-code-review-evals/droid-sentry/pull/10#discussion_r2696085746"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/10"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696085746/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":83,"original_line":83,"side":"RIGHT","author_association":"NONE","original_position":16,"position":16,"subject_type":"line"},{"url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696085978","pull_request_review_id":3667749883,"id":2696085978,"node_id":"PRRC_kwDOQ4pSPs6gswHa","diff_hunk":"@@ -52,17 +64,117 @@ def get(self, request: Request, project, replay_id: str) -> Response:\n         ):\n             return self.respond(status=404)\n \n+        filter_params = self.get_filter_params(request, project)\n+\n+        # Fetch the replay's error IDs from the replay_id.\n+        snuba_response = query_replay_instance(\n+            project_id=project.id,\n+            replay_id=replay_id,\n+            start=filter_params[\"start\"],\n+            end=filter_params[\"end\"],\n+            organization=project.organization,\n+            request_user_id=request.user.id,\n+        )\n+\n+        response = process_raw_response(\n+            snuba_response,\n+            fields=request.query_params.getlist(\"field\"),\n+        )\n+\n+        error_ids = response[0].get(\"error_ids\", []) if response else []\n+\n+        # Check if error fetching should be disabled\n+        disable_error_fetching = (\n+            request.query_params.get(\"enable_error_context\", \"true\").lower() == \"false\"\n+        )\n+\n+        if disable_error_fetching:\n+            error_events = []\n+        else:\n+            error_events = fetch_error_details(project_id=project.id, error_ids=error_ids)\n+\n         return self.paginate(\n             request=request,\n             paginator_cls=GenericOffsetPaginator,\n             data_fn=functools.partial(fetch_segments_metadata, project.id, replay_id),\n-            on_results=analyze_recording_segments,\n+            on_results=functools.partial(analyze_recording_segments, error_events),\n         )\n \n \n+def fetch_error_details(project_id: int, error_ids: list[str]) -> list[ErrorEvent]:\n+    \"\"\"Fetch error details given error IDs and return a list of ErrorEvent objects.\"\"\"\n+    try:\n+        node_ids = [Event.generate_node_id(project_id, event_id=id) for id in error_ids]\n+        events = nodestore.backend.get_multi(node_ids)\n+\n+        return [\n+            ErrorEvent(","path":"src/sentry/replays/endpoints/project_replay_summarize_breadcrumbs.py","commit_id":"ea188e2d736fd6ed27c1dba8aae63b7268e2a7a9","original_commit_id":"ea188e2d736fd6ed27c1dba8aae63b7268e2a7a9","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"[P1] Don’t drop/permute events by zipping error_ids with dict.values()\n\n`nodestore.backend.get_multi()` returns a dict keyed by node_id; `events.values()` iteration order is not guaranteed to match `error_ids`, so this can associate the wrong event data with an error_id (or drop items). Iterate `node_ids` in order and fetch `events.get(node_id)` for each.","created_at":"2026-01-15T21:51:27Z","updated_at":"2026-01-15T21:51:27Z","html_url":"https://github.com/droid-code-review-evals/droid-sentry/pull/10#discussion_r2696085978","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/10","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696085978"},"html":{"href":"https://github.com/droid-code-review-evals/droid-sentry/pull/10#discussion_r2696085978"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/10"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-sentry/pulls/comments/2696085978/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":111,"original_line":111,"side":"RIGHT","author_association":"NONE","original_position":101,"position":101,"subject_type":"line"}]
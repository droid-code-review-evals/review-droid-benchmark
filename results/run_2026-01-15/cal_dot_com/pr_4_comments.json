[{"url":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/comments/2699763744","pull_request_review_id":3672463709,"id":2699763744,"node_id":"PRRC_kwDOQ4pS-86g6yAg","diff_hunk":"@@ -587,16 +477,18 @@ describe(\"InsightsBookingService Integration Tests\", () => {\n         },\n       });\n \n-      const results = await service.findMany({\n-        select: {\n-          id: true,\n-          title: true,\n-        },\n-      });\n+      const baseConditions = await service.getBaseConditions();\n+      const results = await prisma.$queryRaw<{ id: number }[]>`\n+        SELECT id FROM \"BookingTimeStatusDenormalized\"\n+        WHERE ${baseConditions}\n+      `;\n \n       // Should return the user booking since it matches both conditions","path":"packages/lib/server/service/__tests__/insightsBooking.integration-test.ts","commit_id":"56ff75f07b92ba8ef499ff28a2f98c25f339fdae","original_commit_id":"56ff75f07b92ba8ef499ff28a2f98c25f339fdae","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"[P1] Test doesnâ€™t catch the `ANY(${array})` runtime failure\n\nThis test only asserts the returned ids, but with Postgres parameter binding `ANY(${[id]})` can fail before returning results. Consider asserting the query executes by running it against cases where `teamIds` is non-empty and empty to cover the failure mode introduced by the new SQL fragments.","created_at":"2026-01-16T19:46:17Z","updated_at":"2026-01-16T19:46:17Z","html_url":"https://github.com/droid-code-review-evals/droid-cal_dot_com/pull/4#discussion_r2699763744","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/4","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/comments/2699763744"},"html":{"href":"https://github.com/droid-code-review-evals/droid-cal_dot_com/pull/4#discussion_r2699763744"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/4"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/comments/2699763744/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":486,"original_line":486,"side":"RIGHT","author_association":"NONE","original_position":261,"position":261,"subject_type":"line"},{"url":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/comments/2699763746","pull_request_review_id":3672463717,"id":2699763746,"node_id":"PRRC_kwDOQ4pS-86g6yAi","diff_hunk":"@@ -200,20 +193,18 @@ export class InsightsBookingService {\n     });\n     const userIdsFromTeam = usersFromTeam.map((u) => u.userId);\n \n-    return {\n-      OR: [\n-        {\n-          teamId: options.teamId,\n-          isTeamBooking: true,\n-        },\n-        {\n-          userId: {\n-            in: userIdsFromTeam,\n-          },\n-          isTeamBooking: false,\n-        },\n-      ],\n-    };\n+    const conditions: Prisma.Sql[] = [\n+      Prisma.sql`(\"teamId\" = ${options.teamId}) AND (\"isTeamBooking\" = true)`,\n+    ];\n+\n+    if (userIdsFromTeam.length > 0) {\n+      conditions.push(Prisma.sql`(\"userId\" = ANY(${userIdsFromTeam})) AND (\"isTeamBooking\" = false)`);\n+    }\n+\n+    return conditions.reduce((acc, condition, index) => {\n+      if (index === 0) return condition;","path":"packages/lib/server/service/insightsBooking.ts","commit_id":"56ff75f07b92ba8ef499ff28a2f98c25f339fdae","original_commit_id":"56ff75f07b92ba8ef499ff28a2f98c25f339fdae","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"[P0] Avoid `ANY(${userIdsFromTeam})` when array can be empty\n\nWhen `userIdsFromTeam` is empty, this branch is skipped (good), but in the org path `teamIds` can be empty and still hits `ANY(${teamIds})`, yielding invalid SQL (`ANY()` on an empty/non-array bind). Ensure `teamIds.length > 0` or return `NOTHING_CONDITION` / a false predicate.","created_at":"2026-01-16T19:46:17Z","updated_at":"2026-01-16T19:46:17Z","html_url":"https://github.com/droid-code-review-evals/droid-cal_dot_com/pull/4#discussion_r2699763746","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/4","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/comments/2699763746"},"html":{"href":"https://github.com/droid-code-review-evals/droid-cal_dot_com/pull/4#discussion_r2699763746"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/4"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/comments/2699763746/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":205,"original_line":205,"side":"RIGHT","author_association":"NONE","original_position":254,"position":254,"subject_type":"line"},{"url":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/comments/2699763752","pull_request_review_id":3672463725,"id":2699763752,"node_id":"PRRC_kwDOQ4pS-86g6yAo","diff_hunk":"@@ -60,89 +65,86 @@ export class InsightsBookingService {\n     this.filters = filters;\n   }\n \n-  async findMany(findManyArgs: Prisma.BookingTimeStatusDenormalizedFindManyArgs) {\n+  async getBaseConditions(): Promise<Prisma.Sql> {\n     const authConditions = await this.getAuthorizationConditions();\n     const filterConditions = await this.getFilterConditions();\n \n-    return this.prisma.bookingTimeStatusDenormalized.findMany({\n-      ...findManyArgs,\n-      where: {\n-        ...findManyArgs.where,\n-        AND: [authConditions, filterConditions].filter(\n-          (c): c is Prisma.BookingTimeStatusDenormalizedWhereInput => c !== null\n-        ),\n-      },\n-    });\n+    if (authConditions && filterConditions) {\n+      return Prisma.sql`(${authConditions}) AND (${filterConditions})`;\n+    } else if (authConditions) {\n+      return authConditions;\n+    } else if (filterConditions) {\n+      return filterConditions;\n+    } else {\n+      return NOTHING_CONDITION;\n+    }\n   }\n \n-  async getAuthorizationConditions(): Promise<Prisma.BookingTimeStatusDenormalizedWhereInput> {\n+  async getAuthorizationConditions(): Promise<Prisma.Sql> {\n     if (this.cachedAuthConditions === undefined) {\n       this.cachedAuthConditions = await this.buildAuthorizationConditions();\n     }\n     return this.cachedAuthConditions;\n   }\n \n-  async getFilterConditions(): Promise<Prisma.BookingTimeStatusDenormalizedWhereInput | null> {\n+  async getFilterConditions(): Promise<Prisma.Sql | null> {\n     if (this.cachedFilterConditions === undefined) {\n       this.cachedFilterConditions = await this.buildFilterConditions();\n     }\n     return this.cachedFilterConditions;\n   }\n \n-  async buildFilterConditions(): Promise<Prisma.BookingTimeStatusDenormalizedWhereInput | null> {\n-    const conditions: Prisma.BookingTimeStatusDenormalizedWhereInput[] = [];\n+  async buildFilterConditions(): Promise<Prisma.Sql | null> {\n+    const conditions: Prisma.Sql[] = [];\n \n     if (!this.filters) {\n       return null;\n     }\n \n     if (this.filters.eventTypeId) {\n-      conditions.push({\n-        OR: [{ eventTypeId: this.filters.eventTypeId }, { eventParentId: this.filters.eventTypeId }],\n-      });\n+      conditions.push(\n+        Prisma.sql`(\"eventTypeId\" = ${this.filters.eventTypeId}) OR (\"eventParentId\" = ${this.filters.eventTypeId})`\n+      );\n     }\n \n     if (this.filters.memberUserId) {\n-      conditions.push({\n-        userId: this.filters.memberUserId,\n-      });\n+      conditions.push(Prisma.sql`\"userId\" = ${this.filters.memberUserId}`);\n     }\n \n-    return conditions.length > 0 ? { AND: conditions } : null;\n+    if (conditions.length === 0) {\n+      return null;\n+    }\n+","path":"packages/lib/server/service/insightsBooking.ts","commit_id":"56ff75f07b92ba8ef499ff28a2f98c25f339fdae","original_commit_id":"56ff75f07b92ba8ef499ff28a2f98c25f339fdae","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"[P0] Fix invalid SQL from reduce() without initial accumulator\n\n`conditions.reduce((acc, condition, index) => index === 0 ? condition : Prisma.sql`(${acc}) AND (${condition})`)` returns a `Prisma.Sql` fragment on the first iteration, but `acc` is inferred as `Prisma.Sql | string` and can stringify incorrectly; this can emit malformed SQL at runtime when `conditions.length > 1`.","created_at":"2026-01-16T19:46:17Z","updated_at":"2026-01-16T19:46:17Z","html_url":"https://github.com/droid-code-review-evals/droid-cal_dot_com/pull/4#discussion_r2699763752","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/4","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/comments/2699763752"},"html":{"href":"https://github.com/droid-code-review-evals/droid-cal_dot_com/pull/4#discussion_r2699763752"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/4"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/comments/2699763752/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":117,"original_line":117,"side":"RIGHT","author_association":"NONE","original_position":123,"position":123,"subject_type":"line"},{"url":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/comments/2699764201","pull_request_review_id":3672464320,"id":2699764201,"node_id":"PRRC_kwDOQ4pS-86g6yHp","diff_hunk":"@@ -159,39 +161,30 @@ export class InsightsBookingService {\n           )\n         : [];\n \n-    return {\n-      OR: [\n-        {\n-          teamId: {\n-            in: teamIds,\n-          },\n-          isTeamBooking: true,\n-        },\n-        ...(userIdsFromOrg.length > 0\n-          ? [\n-              {\n-                userId: {\n-                  in: Array.from(new Set(userIdsFromOrg)),\n-                },\n-                isTeamBooking: false,\n-              },\n-            ]\n-          : []),\n-      ],\n-    };\n+    const conditions: Prisma.Sql[] = [Prisma.sql`(\"teamId\" = ANY(${teamIds})) AND (\"isTeamBooking\" = true)`];\n+\n+    if (userIdsFromOrg.length > 0) {\n+      const uniqueUserIds = Array.from(new Set(userIdsFromOrg));\n+      conditions.push(Prisma.sql`(\"userId\" = ANY(${uniqueUserIds})) AND (\"isTeamBooking\" = false)`);","path":"packages/lib/server/service/insightsBooking.ts","commit_id":"56ff75f07b92ba8ef499ff28a2f98c25f339fdae","original_commit_id":"56ff75f07b92ba8ef499ff28a2f98c25f339fdae","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"[P0] Fix `ANY(${teamIds})` array binding (runtime SQL error)\n\n`\"teamId\" = ANY(${teamIds})` expects a single Postgres array parameter, but Prisma will bind `${teamIds}` as multiple parameters; this breaks `ANY()` at runtime. Prefer `\"teamId\" IN (${Prisma.join(teamIds)})` (with an empty-array guard) or pass a typed array parameter explicitly.","created_at":"2026-01-16T19:46:28Z","updated_at":"2026-01-16T19:46:28Z","html_url":"https://github.com/droid-code-review-evals/droid-cal_dot_com/pull/4#discussion_r2699764201","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/4","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/comments/2699764201"},"html":{"href":"https://github.com/droid-code-review-evals/droid-cal_dot_com/pull/4#discussion_r2699764201"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/4"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/comments/2699764201/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":168,"original_line":168,"side":"RIGHT","author_association":"NONE","original_position":202,"position":202,"subject_type":"line"}]
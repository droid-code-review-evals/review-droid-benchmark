[{"url":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/comments/2699764746","pull_request_review_id":3672465151,"id":2699764746,"node_id":"PRRC_kwDOQ4pS-86g6yQK","diff_hunk":"@@ -0,0 +1,93 @@\n+import type { NextApiRequest, NextApiResponse } from \"next\";\n+import z from \"zod\";\n+\n+import { appStoreMetadata } from \"@calcom/app-store/appStoreMetaData\";\n+import { APP_CREDENTIAL_SHARING_ENABLED } from \"@calcom/lib/constants\";\n+import { symmetricDecrypt } from \"@calcom/lib/crypto\";\n+import prisma from \"@calcom/prisma\";\n+\n+const appCredentialWebhookRequestBodySchema = z.object({\n+  // UserId of the cal.com user\n+  userId: z.number().int(),\n+  appSlug: z.string(),\n+  // Keys should be AES256 encrypted with the CALCOM_APP_CREDENTIAL_ENCRYPTION_KEY\n+  keys: z.string(),\n+});\n+/** */\n+export default async function handler(req: NextApiRequest, res: NextApiResponse) {\n+  // Check that credential sharing is enabled","path":"apps/web/pages/api/webhook/app-credential.ts","commit_id":"824145b0e245661875240ed5c8745decd2293d1a","original_commit_id":"824145b0e245661875240ed5c8745decd2293d1a","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"[P1] Normalize webhook header lookup (Node lowercases header keys)\n\n`req.headers[...]` keys are lowercased in Node; if `CALCOM_WEBHOOK_HEADER_NAME` is provided with any uppercase characters, this lookup will miss and always 403. Consider lowercasing the env var (and/or using `req.headers[String(name).toLowerCase()]`).","created_at":"2026-01-16T19:46:40Z","updated_at":"2026-01-16T19:46:40Z","html_url":"https://github.com/droid-code-review-evals/droid-cal_dot_com/pull/7#discussion_r2699764746","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/7","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/comments/2699764746"},"html":{"href":"https://github.com/droid-code-review-evals/droid-cal_dot_com/pull/7#discussion_r2699764746"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/7"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/comments/2699764746/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":18,"original_line":18,"side":"RIGHT","author_association":"NONE","original_position":18,"position":18,"subject_type":"line"},{"url":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/comments/2699764747","pull_request_review_id":3672465152,"id":2699764747,"node_id":"PRRC_kwDOQ4pS-86g6yQL","diff_hunk":"@@ -0,0 +1,32 @@\n+import { z } from \"zod\";\n+\n+import { APP_CREDENTIAL_SHARING_ENABLED } from \"@calcom/lib/constants\";\n+\n+const minimumTokenResponseSchema = z.object({\n+  access_token: z.string(),","path":"packages/app-store/_utils/oauth/parseRefreshTokenResponse.ts","commit_id":"824145b0e245661875240ed5c8745decd2293d1a","original_commit_id":"824145b0e245661875240ed5c8745decd2293d1a","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"[P0] Fix invalid Zod schema and return type in token parsing\n\n`minimumTokenResponseSchema` uses computed keys (`[z.string().toString()]`) which isnâ€™t valid in `z.object()`, and this helper returns the full `safeParse` result but several callers treat it as the parsed data (e.g. spreading `.data`). This will either fail at runtime or corrupt the stored credential shape.","created_at":"2026-01-16T19:46:40Z","updated_at":"2026-01-16T19:46:40Z","html_url":"https://github.com/droid-code-review-evals/droid-cal_dot_com/pull/7#discussion_r2699764747","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/7","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/comments/2699764747"},"html":{"href":"https://github.com/droid-code-review-evals/droid-cal_dot_com/pull/7#discussion_r2699764747"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/7"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/comments/2699764747/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":6,"original_line":6,"side":"RIGHT","author_association":"NONE","original_position":6,"position":6,"subject_type":"line"},{"url":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/comments/2699764748","pull_request_review_id":3672465153,"id":2699764748,"node_id":"PRRC_kwDOQ4pS-86g6yQM","diff_hunk":"@@ -60,6 +72,32 @@ export default class SalesforceCalendarService implements Calendar {\n \n     const credentialKey = credential.key as unknown as ExtendedTokenResponse;\n \n+    const response = await fetch(\"https://login.salesforce.com/services/oauth2/token\", {\n+      method: \"POST\",\n+      body: new URLSearchParams({\n+        grant_type: \"refresh_token\",\n+        client_id: consumer_key,\n+        client_secret: consumer_secret,\n+        refresh_token: credentialKey.refresh_token,\n+        format: \"json\",\n+      }),\n+    });\n+\n+    if (response.statusText !== \"OK\") throw new HttpError({ statusCode: 400, message: response.statusText });\n+\n+    const accessTokenJson = await response.json();\n+\n+    const accessTokenParsed = parseRefreshTokenResponse(accessTokenJson, salesforceTokenSchema);\n+\n+    if (!accessTokenParsed.success) {\n+      return Promise.reject(new Error(\"Invalid refreshed tokens were returned\"));\n+    }\n+\n+    await prisma.credential.update({\n+      where: { id: credential.id },\n+      data: { key: { ...accessTokenParsed.data, refresh_token: credentialKey.refresh_token } },\n+    });","path":"packages/app-store/salesforce/lib/CalendarService.ts","commit_id":"824145b0e245661875240ed5c8745decd2293d1a","original_commit_id":"824145b0e245661875240ed5c8745decd2293d1a","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"[P1] Use refreshed token values for the jsforce connection\n\nYou refresh and persist new tokens, but `jsforce.Connection` is still constructed with `credentialKey.access_token` (stale) rather than the refreshed `accessTokenParsed.data.access_token`. This can cause immediate auth failures after refresh.","created_at":"2026-01-16T19:46:40Z","updated_at":"2026-01-16T19:46:40Z","html_url":"https://github.com/droid-code-review-evals/droid-cal_dot_com/pull/7#discussion_r2699764748","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/7","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/comments/2699764748"},"html":{"href":"https://github.com/droid-code-review-evals/droid-cal_dot_com/pull/7#discussion_r2699764748"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/7"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/comments/2699764748/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":99,"original_line":99,"side":"RIGHT","author_association":"NONE","original_position":61,"position":61,"subject_type":"line"},{"url":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/comments/2699764753","pull_request_review_id":3672465159,"id":2699764753,"node_id":"PRRC_kwDOQ4pS-86g6yQR","diff_hunk":"@@ -60,6 +72,32 @@ export default class SalesforceCalendarService implements Calendar {\n \n     const credentialKey = credential.key as unknown as ExtendedTokenResponse;\n \n+    const response = await fetch(\"https://login.salesforce.com/services/oauth2/token\", {\n+      method: \"POST\",\n+      body: new URLSearchParams({\n+        grant_type: \"refresh_token\",\n+        client_id: consumer_key,\n+        client_secret: consumer_secret,\n+        refresh_token: credentialKey.refresh_token,\n+        format: \"json\",\n+      }),\n+    });\n+\n+    if (response.statusText !== \"OK\") throw new HttpError({ statusCode: 400, message: response.statusText });\n+\n+    const accessTokenJson = await response.json();\n+\n+    const accessTokenParsed = parseRefreshTokenResponse(accessTokenJson, salesforceTokenSchema);\n+\n+    if (!accessTokenParsed.success) {\n+      return Promise.reject(new Error(\"Invalid refreshed tokens were returned\"));","path":"packages/app-store/salesforce/lib/CalendarService.ts","commit_id":"824145b0e245661875240ed5c8745decd2293d1a","original_commit_id":"824145b0e245661875240ed5c8745decd2293d1a","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"[P0] Import missing `prisma` before updating credentials\n\nThis file calls `prisma.credential.update(...)` but `prisma` is not imported, which will crash on the first token refresh path with `ReferenceError: prisma is not defined`.","created_at":"2026-01-16T19:46:40Z","updated_at":"2026-01-16T19:46:40Z","html_url":"https://github.com/droid-code-review-evals/droid-cal_dot_com/pull/7#discussion_r2699764753","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/7","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/comments/2699764753"},"html":{"href":"https://github.com/droid-code-review-evals/droid-cal_dot_com/pull/7#discussion_r2699764753"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/7"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/comments/2699764753/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":93,"original_line":93,"side":"RIGHT","author_association":"NONE","original_position":55,"position":55,"subject_type":"line"},{"url":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/comments/2699764755","pull_request_review_id":3672465162,"id":2699764755,"node_id":"PRRC_kwDOQ4pS-86g6yQT","diff_hunk":"@@ -81,11 +82,16 @@ export default class BiginCalendarService implements Calendar {\n       refresh_token: credentialKey.refresh_token,\n     };\n \n-    const tokenInfo = await axios.post(accountsUrl, qs.stringify(formData), {\n-      headers: {\n-        \"Content-Type\": \"application/x-www-form-urlencoded;charset=utf-8\",\n-      },\n-    });\n+    const tokenInfo = await refreshOAuthTokens(\n+      async () =>\n+        await axios.post(accountsUrl, qs.stringify(formData), {","path":"packages/app-store/zoho-bigin/lib/CalendarService.ts","commit_id":"824145b0e245661875240ed5c8745decd2293d1a","original_commit_id":"824145b0e245661875240ed5c8745decd2293d1a","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"[P1] Pass userId (not credentialId) into refreshOAuthTokens\n\n`refreshOAuthTokens` expects a Cal.com `userId` to decide whether to call the sync endpoint, but this passes `credentialId`. That can incorrectly trigger syncing with the wrong identifier and return the wrong tokens for a different user.","created_at":"2026-01-16T19:46:41Z","updated_at":"2026-01-16T19:46:41Z","html_url":"https://github.com/droid-code-review-evals/droid-cal_dot_com/pull/7#discussion_r2699764755","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/7","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/comments/2699764755"},"html":{"href":"https://github.com/droid-code-review-evals/droid-cal_dot_com/pull/7#discussion_r2699764755"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/7"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/comments/2699764755/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":87,"original_line":87,"side":"RIGHT","author_association":"NONE","original_position":19,"position":19,"subject_type":"line"}]
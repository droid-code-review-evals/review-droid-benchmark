[{"url":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/comments/2699764058","pull_request_review_id":3672464148,"id":2699764058,"node_id":"PRRC_kwDOQ4pS-86g6yFa","diff_hunk":"@@ -28,10 +28,19 @@ async function handler(req: NextApiRequest, res: NextApiResponse) {\n   //delete all scheduled sms reminders where scheduled date is past current date\n   await prisma.workflowReminder.deleteMany({\n     where: {\n-      method: WorkflowMethods.SMS,\n-      scheduledDate: {\n-        lte: dayjs().toISOString(),\n-      },\n+      OR: [\n+        {\n+          method: WorkflowMethods.SMS,\n+          scheduledDate: {\n+            lte: dayjs().toISOString(),\n+          },\n+        },\n+        {\n+          retryCount: {\n+            gt: 1,","path":"packages/features/ee/workflows/api/scheduleSMSReminders.ts","commit_id":"2dae0bfb8c72b51aa49260dc1f7f215a6290f3a6","original_commit_id":"2dae0bfb8c72b51aa49260dc1f7f215a6290f3a6","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"**[P1] Restrict deleteMany retryCount clause to SMS reminders**\n\nAs written, the `OR` deletes *any* `WorkflowReminder` with `retryCount > 1` regardless of method, which can wipe out email/whatsapp reminders once they gain retries. Make the second branch include `method: WorkflowMethods.SMS` (or move `method` outside the `OR`) so this cleanup only targets SMS.","created_at":"2026-01-16T19:46:24Z","updated_at":"2026-01-16T19:46:24Z","html_url":"https://github.com/droid-code-review-evals/droid-cal_dot_com/pull/8#discussion_r2699764058","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/8","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/comments/2699764058"},"html":{"href":"https://github.com/droid-code-review-evals/droid-cal_dot_com/pull/8#discussion_r2699764058"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/8"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/comments/2699764058/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":40,"original_line":40,"side":"RIGHT","author_association":"NONE","original_position":17,"position":17,"subject_type":"line"},{"url":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/comments/2699764229","pull_request_review_id":3672464349,"id":2699764229,"node_id":"PRRC_kwDOQ4pS-86g6yIF","diff_hunk":"@@ -163,9 +175,26 @@ async function handler(req: NextApiRequest, res: NextApiResponse) {\n               referenceId: scheduledSMS.sid,\n             },\n           });\n+        } else {\n+          await prisma.workflowReminder.update({\n+            where: {\n+              id: reminder.id,\n+            },\n+            data: {\n+              retryCount: reminder.retryCount + 1,\n+            },\n+          });\n         }\n       }","path":"packages/features/ee/workflows/api/scheduleSMSReminders.ts","commit_id":"2dae0bfb8c72b51aa49260dc1f7f215a6290f3a6","original_commit_id":"2dae0bfb8c72b51aa49260dc1f7f215a6290f3a6","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"**[P1] Avoid lost updates when incrementing retryCount**\n\n`retryCount: reminder.retryCount + 1` can undercount retries when multiple cron runs/processes handle the same reminder concurrently (both read the same value then write back the same increment). Prefer an atomic increment:\n```ts\nretryCount: { increment: 1 }\n```","created_at":"2026-01-16T19:46:28Z","updated_at":"2026-01-16T19:46:29Z","html_url":"https://github.com/droid-code-review-evals/droid-cal_dot_com/pull/8#discussion_r2699764229","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/8","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/comments/2699764229"},"html":{"href":"https://github.com/droid-code-review-evals/droid-cal_dot_com/pull/8#discussion_r2699764229"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/8"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-cal_dot_com/pulls/comments/2699764229/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":188,"original_line":188,"side":"RIGHT","author_association":"NONE","original_position":52,"position":52,"subject_type":"line"}]
[{"url":"https://api.github.com/repos/droid-code-review-evals/droid-keycloak/pulls/comments/2699750751","pull_request_review_id":3672446764,"id":2699750751,"node_id":"PRRC_kwDOQ4pSo86g6u1f","diff_hunk":"@@ -41,12 +48,129 @@ public List<String> verify() throws MojoExecutionException {\n         try {\n             String contents = Files.readString(file.toPath());\n             verifyNoDuplicateKeys(contents);\n+            verifySafeHtml();\n         } catch (IOException e) {\n             throw new MojoExecutionException(\"Can not read file \" + file, e);\n         }\n         return messages;\n     }\n \n+    PolicyFactory POLICY_SOME_HTML = new org.owasp.html.HtmlPolicyBuilder()\n+            .allowElements(\n+                    \"br\", \"p\", \"strong\", \"b\"\n+            ).toFactory();\n+\n+    PolicyFactory POLICY_NO_HTML = new org.owasp.html.HtmlPolicyBuilder().toFactory();\n+\n+    private void verifySafeHtml() {\n+        PropertyResourceBundle bundle;\n+        try (FileInputStream fis = new FileInputStream(file)) {\n+            bundle = new PropertyResourceBundle(fis);\n+        } catch (IOException e) {","path":"misc/theme-verifier/src/main/java/org/keycloak/themeverifier/VerifyMessageProperties.java","commit_id":"5d77e7ea7d431aa0a6b65904457b7471bd050e81","original_commit_id":"5d77e7ea7d431aa0a6b65904457b7471bd050e81","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"**[P0] Avoid failing when English bundle file is missing**\n\n`verifySafeHtml()` unconditionally opens the computed `*_en.properties` file; for fixtures like `illegalHtmlTag_en.properties` and `duplicateKeys_en.properties` there is no corresponding `_en_en.properties`, so this path throws and breaks `theme-verifier` (and its tests) instead of reporting a validation message.","created_at":"2026-01-16T19:41:25Z","updated_at":"2026-01-16T19:41:25Z","html_url":"https://github.com/droid-code-review-evals/droid-keycloak/pull/7#discussion_r2699750751","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-keycloak/pulls/7","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-keycloak/pulls/comments/2699750751"},"html":{"href":"https://github.com/droid-code-review-evals/droid-keycloak/pull/7#discussion_r2699750751"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-keycloak/pulls/7"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-keycloak/pulls/comments/2699750751/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":69,"original_line":69,"side":"RIGHT","author_association":"NONE","original_position":45,"position":45,"subject_type":"line"},{"url":"https://api.github.com/repos/droid-code-review-evals/droid-keycloak/pulls/comments/2699751057","pull_request_review_id":3672447154,"id":2699751057,"node_id":"PRRC_kwDOQ4pSo86g6u6R","diff_hunk":"@@ -41,12 +48,129 @@ public List<String> verify() throws MojoExecutionException {\n         try {\n             String contents = Files.readString(file.toPath());\n             verifyNoDuplicateKeys(contents);\n+            verifySafeHtml();\n         } catch (IOException e) {\n             throw new MojoExecutionException(\"Can not read file \" + file, e);\n         }\n         return messages;\n     }\n \n+    PolicyFactory POLICY_SOME_HTML = new org.owasp.html.HtmlPolicyBuilder()\n+            .allowElements(\n+                    \"br\", \"p\", \"strong\", \"b\"\n+            ).toFactory();\n+\n+    PolicyFactory POLICY_NO_HTML = new org.owasp.html.HtmlPolicyBuilder().toFactory();\n+\n+    private void verifySafeHtml() {\n+        PropertyResourceBundle bundle;\n+        try (FileInputStream fis = new FileInputStream(file)) {\n+            bundle = new PropertyResourceBundle(fis);\n+        } catch (IOException e) {\n+            throw new RuntimeException(\"unable to read file \" + file, e);\n+        }\n+\n+        PropertyResourceBundle bundleEnglish;\n+        String englishFile = file.getAbsolutePath().replaceAll(\"resources-community\", \"resources\")\n+                .replaceAll(\"_[a-zA-Z-_]*\\\\.properties\", \"_en.properties\");\n+        try (FileInputStream fis = new FileInputStream(englishFile)) {\n+            bundleEnglish = new PropertyResourceBundle(fis);\n+        } catch (IOException e) {\n+            throw new RuntimeException(\"unable to read file \" + englishFile, e);\n+        }\n+\n+        bundle.getKeys().asIterator().forEachRemaining(key -> {\n+            String value = bundle.getString(key);\n+            value = normalizeValue(key, value);\n+            String englishValue = getEnglishValue(key, bundleEnglish);\n+            englishValue = normalizeValue(key, englishValue);\n+\n+            value = santizeAnchors(key, value, englishValue);\n+\n+            // Only if the English source string contains HTML we also allow HTML in the translation\n+            PolicyFactory policy = containsHtml(englishValue) ? POLICY_SOME_HTML : POLICY_NO_HTML;\n+            String sanitized = policy.sanitize(value);\n+\n+            // Sanitizer will escape HTML entities for quotes and also for numberic tags like '<1>'\n+            sanitized = org.apache.commons.text.StringEscapeUtils.unescapeHtml4(sanitized);\n+            // Sanitizer will add them when there are double curly braces\n+            sanitized = sanitized.replace(\"<!-- -->\", \"\");\n+\n+            if (!Objects.equals(sanitized, value)) {\n+\n+                // Strip identical characters from the beginning and the end to show where the difference is\n+                int start = 0;\n+                while (start < sanitized.length() && start < value.length() && value.charAt(start) == sanitized.charAt(start)) {\n+                    start++;\n+                }\n+                int end = 0;\n+                while (end < sanitized.length() && end < value.length() && value.charAt(value.length() - end - 1) == sanitized.charAt(sanitized.length() - end - 1)) {\n+                    end++;\n+                }\n+\n+                messages.add(\"Illegal HTML in key \" + key + \" for file \" + file + \": '\" + value.substring(start, value.length() - end) + \"' vs. '\" + sanitized.substring(start, sanitized.length() - end) + \"'\");\n+            }\n+\n+        });\n+    }\n+\n+    private String normalizeValue(String key, String value) {\n+        if (key.equals(\"templateHelp\")) {\n+            // Allow \"CLAIM.<NAME>\" here\n+            value = value.replaceAll(\"CLAIM\\\\.<[A-Z]*>\", \"\");\n+        } else if (key.equals(\"optimizeLookupHelp\")) {\n+            // Allow \"<Extensions>\" here\n+            value = value.replaceAll(\"<Extensions>\", \"\");\n+        } else if (key.startsWith(\"linkExpirationFormatter.timePeriodUnit\") || key.equals(\"error-invalid-multivalued-size\")) {\n+            // The problem is the \"<\" that appears in the choice\n+            value = value.replaceAll(\"\\\\{[0-9]+,choice,[^}]*}\", \"...\");\n+        }\n+\n+        // Unescape HTML entities, as we later also unescape HTML entities in the sanitized value\n+        value = org.apache.commons.text.StringEscapeUtils.unescapeHtml4(value);\n+\n+        if (file.getAbsolutePath().contains(\"email\")) {\n+            // TODO: move the RTL information for emails\n+            value = value.replaceAll(Pattern.quote(\" style=\\\"direction: rtl;\\\"\"), \"\");\n+        }\n+        return value;\n+    }\n+","path":"misc/theme-verifier/src/main/java/org/keycloak/themeverifier/VerifyMessageProperties.java","commit_id":"5d77e7ea7d431aa0a6b65904457b7471bd050e81","original_commit_id":"5d77e7ea7d431aa0a6b65904457b7471bd050e81","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"**[P1] Fix anchor sanitization logic (removes wrong string)**\n\nWhen an anchor matches, the code removes `englishMatcher.group()` from `value`:\n```java\nvalue = value.replaceFirst(Pattern.quote(englishMatcher.group()), \"\");\n```\nThis should remove `matcher.group()` (the tag found in `value`); as written it can fail to remove the tag (or remove an unrelated substring) and then `sanitized != value` will flag legitimate translations.","created_at":"2026-01-16T19:41:30Z","updated_at":"2026-01-16T19:41:30Z","html_url":"https://github.com/droid-code-review-evals/droid-keycloak/pull/7#discussion_r2699751057","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-keycloak/pulls/7","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-keycloak/pulls/comments/2699751057"},"html":{"href":"https://github.com/droid-code-review-evals/droid-keycloak/pull/7#discussion_r2699751057"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-keycloak/pulls/7"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-keycloak/pulls/comments/2699751057/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":138,"original_line":138,"side":"RIGHT","author_association":"NONE","original_position":114,"position":114,"subject_type":"line"}]
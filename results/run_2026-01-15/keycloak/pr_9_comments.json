[{"url":"https://api.github.com/repos/droid-code-review-evals/droid-keycloak/pulls/comments/2699750868","pull_request_review_id":3672446943,"id":2699750868,"node_id":"PRRC_kwDOQ4pSo86g6u3U","diff_hunk":"@@ -5,16 +5,18 @@\n import org.keycloak.models.RealmModel;\n import org.keycloak.models.UserModel;\n import org.keycloak.models.credential.RecoveryAuthnCodesCredentialModel;\n+import org.keycloak.models.utils.RecoveryAuthnCodesUtils;\n+\n+import java.util.Optional;\n \n public class RecoveryAuthnCodeInputLoginBean {\n \n     private final int codeNumber;\n \n     public RecoveryAuthnCodeInputLoginBean(KeycloakSession session, RealmModel realm, UserModel user) {\n-        CredentialModel credentialModel = user.credentialManager().getStoredCredentialsByTypeStream(RecoveryAuthnCodesCredentialModel.TYPE)\n-                                                 .findFirst().get();\n+        Optional<CredentialModel> credentialModelOpt = RecoveryAuthnCodesUtils.getCredential(user);\n ","path":"services/src/main/java/org/keycloak/forms/login/freemarker/model/RecoveryAuthnCodeInputLoginBean.java","commit_id":"134437a5a7e31472763ffa2ac3cc91030e7ee389","original_commit_id":"134437a5a7e31472763ffa2ac3cc91030e7ee389","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"[P0] Avoid Optional.get() crash when no recovery codes exist\n\n`RecoveryAuthnCodesUtils.getCredential(user)` can return `Optional.empty()`, and `credentialModelOpt.get()` will throw `NoSuchElementException` (e.g., user hits the recovery-code login page without having codes configured or stored via user storage).","created_at":"2026-01-16T19:41:27Z","updated_at":"2026-01-16T19:41:27Z","html_url":"https://github.com/droid-code-review-evals/droid-keycloak/pull/9#discussion_r2699750868","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-keycloak/pulls/9","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-keycloak/pulls/comments/2699750868"},"html":{"href":"https://github.com/droid-code-review-evals/droid-keycloak/pull/9#discussion_r2699750868"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-keycloak/pulls/9"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-keycloak/pulls/comments/2699750868/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":18,"original_line":18,"side":"RIGHT","author_association":"NONE","original_position":16,"position":16,"subject_type":"line"},{"url":"https://api.github.com/repos/droid-code-review-evals/droid-keycloak/pulls/comments/2699751079","pull_request_review_id":3672447193,"id":2699751079,"node_id":"PRRC_kwDOQ4pSo86g6u6n","diff_hunk":"@@ -213,6 +227,30 @@ private MyUser getMyUser(UserModel user) {\n         return users.get(translateUserName(user.getUsername()));\n     }\n \n+    @Override\n+    public Stream<CredentialModel> getCredentials(RealmModel realm, UserModel user) {\n+        var myUser = getMyUser(user);\n+        RecoveryAuthnCodesCredentialModel model;\n+        List<CredentialModel> credentialModels = new ArrayList<>();\n+        if (myUser.recoveryCodes != null) {\n+            try {\n+                model = RecoveryAuthnCodesCredentialModel.createFromValues(\n+                        JsonSerialization.readValue(myUser.recoveryCodes.getCredentialData(), List.class),\n+                        myUser.recoveryCodes.getCreatedDate(),\n+                        myUser.recoveryCodes.getUserLabel()\n+                );\n+                credentialModels.add(model);\n+            } catch (IOException e) {\n+                log.error(\"Could not deserialize  credential of type: recovery-codes\");\n+            }\n+        }\n+        if (myUser.otp != null) {\n+            credentialModels.add(myUser.getOtp());\n+        }\n+","path":"testsuite/integration-arquillian/servers/auth-server/services/testsuite-providers/src/main/java/org/keycloak/testsuite/federation/BackwardsCompatibilityUserStorage.java","commit_id":"134437a5a7e31472763ffa2ac3cc91030e7ee389","original_commit_id":"134437a5a7e31472763ffa2ac3cc91030e7ee389","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"[P0] Prevent NPE in getCredentials() for unknown users\n\n`getMyUser(user)` can return null (e.g., user not present in this provider), but `myUser.recoveryCodes` / `myUser.otp` are dereferenced unconditionally, causing an immediate `NullPointerException`.","created_at":"2026-01-16T19:41:31Z","updated_at":"2026-01-16T19:41:31Z","html_url":"https://github.com/droid-code-review-evals/droid-keycloak/pull/9#discussion_r2699751079","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-keycloak/pulls/9","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-keycloak/pulls/comments/2699751079"},"html":{"href":"https://github.com/droid-code-review-evals/droid-keycloak/pull/9#discussion_r2699751079"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-keycloak/pulls/9"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-keycloak/pulls/comments/2699751079/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":250,"original_line":250,"side":"RIGHT","author_association":"NONE","original_position":112,"position":112,"subject_type":"line"}]
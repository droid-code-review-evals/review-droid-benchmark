[{"url":"https://api.github.com/repos/droid-code-review-evals/droid-keycloak/pulls/comments/2699749978","pull_request_review_id":3672445369,"id":2699749978,"node_id":"PRRC_kwDOQ4pSo86g6upa","diff_hunk":"@@ -0,0 +1,226 @@\n+/*\n+ * Copyright 2024 Red Hat, Inc. and/or its affiliates\n+ *  and other contributors as indicated by the @author tags.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *  http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *\n+ */\n+\n+package org.keycloak.authorization.client.util.crypto;\n+\n+import java.io.IOException;\n+import java.math.BigInteger;\n+import java.security.InvalidAlgorithmParameterException;\n+import java.security.KeyFactory;\n+import java.security.KeyPairGenerator;\n+import java.security.KeyStore;\n+import java.security.KeyStoreException;\n+import java.security.NoSuchAlgorithmException;\n+import java.security.NoSuchProviderException;\n+import java.security.Provider;\n+import java.security.Signature;\n+import java.security.cert.CertPathBuilder;\n+import java.security.cert.CertStore;\n+import java.security.cert.CertificateException;\n+import java.security.cert.CertificateFactory;\n+import java.security.cert.CollectionCertStoreParameters;\n+import java.security.interfaces.ECPrivateKey;\n+import java.security.interfaces.ECPublicKey;\n+import java.security.spec.ECParameterSpec;\n+import java.util.List;\n+import javax.crypto.Cipher;\n+import javax.crypto.NoSuchPaddingException;\n+import javax.crypto.SecretKeyFactory;\n+import javax.net.ssl.SSLSocketFactory;\n+import org.keycloak.common.crypto.CertificateUtilsProvider;\n+import org.keycloak.common.crypto.CryptoProvider;\n+import org.keycloak.common.crypto.ECDSACryptoProvider;\n+import org.keycloak.common.crypto.PemUtilsProvider;\n+import org.keycloak.common.crypto.UserIdentityExtractorProvider;\n+import org.keycloak.common.util.KeystoreUtil;\n+\n+/**\n+ * <p>Simple crypto provider to be used with the authz-client.</p>\n+ *\n+ * @author rmartinc\n+ */\n+public class AuthzClientCryptoProvider implements CryptoProvider {\n+\n+    @Override\n+    public Provider getBouncyCastleProvider() {\n+        try {\n+            return KeyStore.getInstance(KeyStore.getDefaultType()).getProvider();\n+        } catch (KeyStoreException e) {\n+            throw new IllegalStateException(e);\n+        }\n+    }\n+\n+    @Override\n+    public int order() {\n+        return 100;\n+    }\n+\n+    @Override\n+    public <T> T getAlgorithmProvider(Class<T> clazz, String algorithm) {\n+        throw new UnsupportedOperationException(\"Not supported yet.\");\n+    }\n+\n+    @Override\n+    public CertificateUtilsProvider getCertificateUtils() {\n+        throw new UnsupportedOperationException(\"Not supported yet.\");\n+    }\n+\n+    @Override\n+    public PemUtilsProvider getPemUtils() {\n+        throw new UnsupportedOperationException(\"Not supported yet.\");","path":"authz/client/src/main/java/org/keycloak/authorization/client/util/crypto/AuthzClientCryptoProvider.java","commit_id":"b95d12a968e8374a93ddcd56f47ab12eb4136ff4","original_commit_id":"b95d12a968e8374a93ddcd56f47ab12eb4136ff4","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"**[P0] Fix ECDSA DER sequence creation that currently discards writes**\n\n`concatenatedRSToASN1DER` creates two encoder instances and writes to them without using the result, which is a no-op; this is misleading and risks future edits assuming those writes affect the returned sequence.\n```java\nASN1Encoder.create().write(rBigInteger);\nASN1Encoder.create().write(sBigInteger);\n```","created_at":"2026-01-16T19:41:06Z","updated_at":"2026-01-16T19:41:06Z","html_url":"https://github.com/droid-code-review-evals/droid-keycloak/pull/3#discussion_r2699749978","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-keycloak/pulls/3","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-keycloak/pulls/comments/2699749978"},"html":{"href":"https://github.com/droid-code-review-evals/droid-keycloak/pull/3#discussion_r2699749978"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-keycloak/pulls/3"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-keycloak/pulls/comments/2699749978/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":86,"original_line":86,"side":"RIGHT","author_association":"NONE","original_position":86,"position":86,"subject_type":"line"},{"url":"https://api.github.com/repos/droid-code-review-evals/droid-keycloak/pulls/comments/2699749979","pull_request_review_id":3672445370,"id":2699749979,"node_id":"PRRC_kwDOQ4pSo86g6upb","diff_hunk":"@@ -0,0 +1,226 @@\n+/*\n+ * Copyright 2024 Red Hat, Inc. and/or its affiliates\n+ *  and other contributors as indicated by the @author tags.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *  http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *\n+ */\n+\n+package org.keycloak.authorization.client.util.crypto;\n+\n+import java.io.IOException;\n+import java.math.BigInteger;\n+import java.security.InvalidAlgorithmParameterException;\n+import java.security.KeyFactory;\n+import java.security.KeyPairGenerator;\n+import java.security.KeyStore;\n+import java.security.KeyStoreException;\n+import java.security.NoSuchAlgorithmException;\n+import java.security.NoSuchProviderException;\n+import java.security.Provider;\n+import java.security.Signature;\n+import java.security.cert.CertPathBuilder;\n+import java.security.cert.CertStore;\n+import java.security.cert.CertificateException;\n+import java.security.cert.CertificateFactory;\n+import java.security.cert.CollectionCertStoreParameters;\n+import java.security.interfaces.ECPrivateKey;\n+import java.security.interfaces.ECPublicKey;\n+import java.security.spec.ECParameterSpec;\n+import java.util.List;\n+import javax.crypto.Cipher;\n+import javax.crypto.NoSuchPaddingException;\n+import javax.crypto.SecretKeyFactory;\n+import javax.net.ssl.SSLSocketFactory;\n+import org.keycloak.common.crypto.CertificateUtilsProvider;\n+import org.keycloak.common.crypto.CryptoProvider;\n+import org.keycloak.common.crypto.ECDSACryptoProvider;\n+import org.keycloak.common.crypto.PemUtilsProvider;\n+import org.keycloak.common.crypto.UserIdentityExtractorProvider;\n+import org.keycloak.common.util.KeystoreUtil;\n+\n+/**\n+ * <p>Simple crypto provider to be used with the authz-client.</p>\n+ *\n+ * @author rmartinc\n+ */\n+public class AuthzClientCryptoProvider implements CryptoProvider {\n+\n+    @Override\n+    public Provider getBouncyCastleProvider() {\n+        try {\n+            return KeyStore.getInstance(KeyStore.getDefaultType()).getProvider();\n+        } catch (KeyStoreException e) {\n+            throw new IllegalStateException(e);\n+        }\n+    }\n+\n+    @Override\n+    public int order() {\n+        return 100;\n+    }\n+\n+    @Override\n+    public <T> T getAlgorithmProvider(Class<T> clazz, String algorithm) {\n+        throw new UnsupportedOperationException(\"Not supported yet.\");\n+    }\n+\n+    @Override\n+    public CertificateUtilsProvider getCertificateUtils() {\n+        throw new UnsupportedOperationException(\"Not supported yet.\");\n+    }\n+\n+    @Override\n+    public PemUtilsProvider getPemUtils() {\n+        throw new UnsupportedOperationException(\"Not supported yet.\");\n+    }\n+\n+    @Override\n+    public <T> T getOCSPProver(Class<T> clazz) {\n+        throw new UnsupportedOperationException(\"Not supported yet.\");\n+    }\n+\n+    @Override\n+    public UserIdentityExtractorProvider getIdentityExtractorProvider() {\n+        throw new UnsupportedOperationException(\"Not supported yet.\");\n+    }\n+\n+    @Override\n+    public ECDSACryptoProvider getEcdsaCryptoProvider() {\n+        return new ECDSACryptoProvider() {\n+            @Override\n+            public byte[] concatenatedRSToASN1DER(byte[] signature, int signLength) throws IOException {\n+                int len = signLength / 2;\n+                int arraySize = len + 1;\n+\n+                byte[] r = new byte[arraySize];\n+                byte[] s = new byte[arraySize];\n+                System.arraycopy(signature, 0, r, 1, len);\n+                System.arraycopy(signature, len, s, 1, len);\n+                BigInteger rBigInteger = new BigInteger(r);\n+                BigInteger sBigInteger = new BigInteger(s);\n+\n+                ASN1Encoder.create().write(rBigInteger);\n+                ASN1Encoder.create().write(sBigInteger);\n+\n+                return ASN1Encoder.create()\n+                        .writeDerSeq(\n+                                ASN1Encoder.create().write(rBigInteger),\n+                                ASN1Encoder.create().write(sBigInteger))\n+                        .toByteArray();\n+            }\n+\n+            @Override\n+            public byte[] asn1derToConcatenatedRS(byte[] derEncodedSignatureValue, int signLength) throws IOException {\n+                int len = signLength / 2;\n+\n+                List<byte[]> seq = ASN1Decoder.create(derEncodedSignatureValue).readSequence();\n+                if (seq.size() != 2) {\n+                    throw new IOException(\"Invalid sequence with size different to 2\");\n+                }\n+\n+                BigInteger rBigInteger = ASN1Decoder.create(seq.get(0)).readInteger();\n+                BigInteger sBigInteger = ASN1Decoder.create(seq.get(1)).readInteger();\n+\n+                byte[] r = integerToBytes(rBigInteger, len);\n+                byte[] s = integerToBytes(sBigInteger, len);\n+\n+                byte[] concatenatedSignatureValue = new byte[signLength];\n+                System.arraycopy(r, 0, concatenatedSignatureValue, 0, len);\n+                System.arraycopy(s, 0, concatenatedSignatureValue, len, len);\n+\n+                return concatenatedSignatureValue;\n+            }\n+\n+            @Override\n+            public ECPublicKey getPublicFromPrivate(ECPrivateKey ecPrivateKey) {\n+                throw new UnsupportedOperationException(\"Not supported yet.\");\n+            }\n+","path":"authz/client/src/main/java/org/keycloak/authorization/client/util/crypto/AuthzClientCryptoProvider.java","commit_id":"b95d12a968e8374a93ddcd56f47ab12eb4136ff4","original_commit_id":"b95d12a968e8374a93ddcd56f47ab12eb4136ff4","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"**[P0] Fix getKeyStore missing provider/exception handling**\n\nThis method calls `KeyStore.getInstance(format.name())` without declaring/handling `NoSuchAlgorithmException`, so it wonâ€™t compile against the JCA signature (the interface only allows `KeyStoreException, NoSuchProviderException`).","created_at":"2026-01-16T19:41:06Z","updated_at":"2026-01-16T19:41:06Z","html_url":"https://github.com/droid-code-review-evals/droid-keycloak/pull/3#discussion_r2699749979","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-keycloak/pulls/3","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-keycloak/pulls/comments/2699749979"},"html":{"href":"https://github.com/droid-code-review-evals/droid-keycloak/pull/3#discussion_r2699749979"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-keycloak/pulls/3"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-keycloak/pulls/comments/2699749979/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":150,"original_line":150,"side":"RIGHT","author_association":"NONE","original_position":150,"position":150,"subject_type":"line"},{"url":"https://api.github.com/repos/droid-code-review-evals/droid-keycloak/pulls/comments/2699749982","pull_request_review_id":3672445374,"id":2699749982,"node_id":"PRRC_kwDOQ4pSo86g6upe","diff_hunk":"@@ -91,6 +92,7 @@ public static AuthzClient create(InputStream configStream) throws RuntimeExcepti\n      * @return a new instance\n      */\n     public static AuthzClient create(Configuration configuration) {\n+        CryptoIntegration.init(AuthzClient.class.getClassLoader());","path":"authz/client/src/main/java/org/keycloak/authorization/client/AuthzClient.java","commit_id":"b95d12a968e8374a93ddcd56f47ab12eb4136ff4","original_commit_id":"b95d12a968e8374a93ddcd56f47ab12eb4136ff4","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"**[P1] Avoid repeated global CryptoIntegration.init on every create()**\n\n`CryptoIntegration.init` mutates global security/provider state; calling it every `AuthzClient.create()` can cause contention or redundant work in multi-client apps. Consider guarding it (e.g., once-per-classloader) or documenting why repeated init is safe.","created_at":"2026-01-16T19:41:06Z","updated_at":"2026-01-16T19:41:06Z","html_url":"https://github.com/droid-code-review-evals/droid-keycloak/pull/3#discussion_r2699749982","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-keycloak/pulls/3","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-keycloak/pulls/comments/2699749982"},"html":{"href":"https://github.com/droid-code-review-evals/droid-keycloak/pull/3#discussion_r2699749982"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-keycloak/pulls/3"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-keycloak/pulls/comments/2699749982/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":95,"original_line":95,"side":"RIGHT","author_association":"NONE","original_position":12,"position":12,"subject_type":"line"}]
[{"url":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/comments/2699750807","pull_request_review_id":3672446856,"id":2699750807,"node_id":"PRRC_kwDOQ4pSe86g6u2X","diff_hunk":"@@ -21,114 +22,151 @@ type DualWriterMode3 struct {\n // newDualWriterMode3 returns a new DualWriter in mode 3.\n // Mode 3 represents writing to LegacyStorage and Storage and reading from Storage.\n func newDualWriterMode3(legacy LegacyStorage, storage Storage, dwm *dualWriterMetrics) *DualWriterMode3 {\n-\treturn &DualWriterMode3{Legacy: legacy, Storage: storage, Log: klog.NewKlogr().WithName(\"DualWriterMode3\"), dualWriterMetrics: dwm}\n+\treturn &DualWriterMode3{Legacy: legacy, Storage: storage, Log: klog.NewKlogr().WithName(\"DualWriterMode3\").WithValues(\"mode\", mode3Str), dualWriterMetrics: dwm}\n }\n \n // Mode returns the mode of the dual writer.\n func (d *DualWriterMode3) Mode() DualWriterMode {\n \treturn Mode3\n }\n \n+const mode3Str = \"3\"\n+\n // Create overrides the behavior of the generic DualWriter and writes to LegacyStorage and Storage.\n func (d *DualWriterMode3) Create(ctx context.Context, obj runtime.Object, createValidation rest.ValidateObjectFunc, options *metav1.CreateOptions) (runtime.Object, error) {\n-\tlog := klog.FromContext(ctx)\n+\tvar method = \"create\"\n+\tlog := d.Log.WithValues(\"kind\", options.Kind, \"method\", method)\n+\tctx = klog.NewContext(ctx, log)\n \n+\tstartStorage := time.Now()\n \tcreated, err := d.Storage.Create(ctx, obj, createValidation, options)\n \tif err != nil {\n \t\tlog.Error(err, \"unable to create object in storage\")\n+\t\td.recordLegacyDuration(true, mode3Str, options.Kind, method, startStorage)\n \t\treturn created, err\n \t}\n+\td.recordStorageDuration(false, mode3Str, options.Kind, method, startStorage)\n \n-\tif _, err := d.Legacy.Create(ctx, obj, createValidation, options); err != nil {\n-\t\tlog.WithValues(\"object\", created).Error(err, \"unable to create object in legacy storage\")\n-\t}\n-\treturn created, nil\n+\tgo func() {\n+\t\tctx, cancel := context.WithTimeoutCause(ctx, time.Second*10, errors.New(\"legacy create timeout\"))\n+\t\tdefer cancel()\n+\n+\t\tstartLegacy := time.Now()\n+\t\t_, errObjectSt := d.Legacy.Create(ctx, obj, createValidation, options)\n+\t\td.recordLegacyDuration(errObjectSt != nil, mode3Str, options.Kind, method, startLegacy)\n+\t}()\n+\n+\treturn created, err\n }\n \n // Get overrides the behavior of the generic DualWriter and retrieves an object from Storage.\n func (d *DualWriterMode3) Get(ctx context.Context, name string, options *metav1.GetOptions) (runtime.Object, error) {\n-\treturn d.Storage.Get(ctx, name, &metav1.GetOptions{})\n+\tvar method = \"get\"\n+\tlog := d.Log.WithValues(\"kind\", options.Kind, \"name\", name, \"method\", method)\n+\tctx = klog.NewContext(ctx, log)\n+\n+\tstartStorage := time.Now()\n+\tres, err := d.Storage.Get(ctx, name, options)\n+\tif err != nil {\n+\t\tlog.Error(err, \"unable to get object in storage\")\n+\t}\n+\td.recordStorageDuration(err != nil, mode3Str, options.Kind, method, startStorage)\n+\n+\treturn res, err\n }\n \n-func (d *DualWriterMode3) Delete(ctx context.Context, name string, deleteValidation rest.ValidateObjectFunc, options *metav1.DeleteOptions) (runtime.Object, bool, error) {\n-\tlog := d.Log.WithValues(\"name\", name)\n+// List overrides the behavior of the generic DualWriter and reads only from Unified Store.\n+func (d *DualWriterMode3) List(ctx context.Context, options *metainternalversion.ListOptions) (runtime.Object, error) {\n+\tvar method = \"list\"\n+\tlog := d.Log.WithValues(\"kind\", options.Kind, \"resourceVersion\", options.ResourceVersion, \"method\", method)\n \tctx = klog.NewContext(ctx, log)\n \n-\tdeleted, async, err := d.Storage.Delete(ctx, name, deleteValidation, options)\n+\tstartStorage := time.Now()\n+\tres, err := d.Storage.List(ctx, options)\n \tif err != nil {\n-\t\tif !apierrors.IsNotFound(err) {\n-\t\t\tlog.Error(err, \"could not delete from unified store\")\n-\t\t\treturn deleted, async, err\n-\t\t}\n+\t\tlog.Error(err, \"unable to list object in storage\")\n \t}\n+\td.recordStorageDuration(err != nil, mode3Str, options.Kind, method, startStorage)\n \n-\t_, _, errLS := d.Legacy.Delete(ctx, name, deleteValidation, options)\n-\tif errLS != nil {\n-\t\tif !apierrors.IsNotFound(errLS) {\n-\t\t\tlog.WithValues(\"deleted\", deleted).Error(errLS, \"could not delete from legacy store\")\n-\t\t}\n+\treturn res, err\n+}\n+\n+func (d *DualWriterMode3) Delete(ctx context.Context, name string, deleteValidation rest.ValidateObjectFunc, options *metav1.DeleteOptions) (runtime.Object, bool, error) {\n+\tvar method = \"delete\"\n+\tlog := d.Log.WithValues(\"name\", name, \"kind\", options.Kind, \"method\", method)\n+\tctx = klog.NewContext(ctx, d.Log)\n+","path":"pkg/apiserver/rest/dualwriter_mode3.go","commit_id":"67b74e1e8a7d26d24617b7313b90fa4649138318","original_commit_id":"67b74e1e8a7d26d24617b7313b90fa4649138318","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"**[P1] Fix context/log propagation in Delete**\n\n`ctx = klog.NewContext(ctx, d.Log)` drops the per-request `log` (with `name/kind/method`) you just built; use `log` so downstream storage calls/metrics include the right fields.","created_at":"2026-01-16T19:41:26Z","updated_at":"2026-01-16T19:41:26Z","html_url":"https://github.com/droid-code-review-evals/droid-grafana/pull/6#discussion_r2699750807","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/6","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/comments/2699750807"},"html":{"href":"https://github.com/droid-code-review-evals/droid-grafana/pull/6#discussion_r2699750807"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/6"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/comments/2699750807/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":98,"original_line":98,"side":"RIGHT","author_association":"NONE","original_position":107,"position":107,"subject_type":"line"},{"url":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/comments/2699751049","pull_request_review_id":3672447144,"id":2699751049,"node_id":"PRRC_kwDOQ4pSe86g6u6J","diff_hunk":"@@ -21,114 +22,151 @@ type DualWriterMode3 struct {\n // newDualWriterMode3 returns a new DualWriter in mode 3.\n // Mode 3 represents writing to LegacyStorage and Storage and reading from Storage.\n func newDualWriterMode3(legacy LegacyStorage, storage Storage, dwm *dualWriterMetrics) *DualWriterMode3 {\n-\treturn &DualWriterMode3{Legacy: legacy, Storage: storage, Log: klog.NewKlogr().WithName(\"DualWriterMode3\"), dualWriterMetrics: dwm}\n+\treturn &DualWriterMode3{Legacy: legacy, Storage: storage, Log: klog.NewKlogr().WithName(\"DualWriterMode3\").WithValues(\"mode\", mode3Str), dualWriterMetrics: dwm}\n }\n \n // Mode returns the mode of the dual writer.\n func (d *DualWriterMode3) Mode() DualWriterMode {\n \treturn Mode3\n }\n \n+const mode3Str = \"3\"\n+\n // Create overrides the behavior of the generic DualWriter and writes to LegacyStorage and Storage.\n func (d *DualWriterMode3) Create(ctx context.Context, obj runtime.Object, createValidation rest.ValidateObjectFunc, options *metav1.CreateOptions) (runtime.Object, error) {\n-\tlog := klog.FromContext(ctx)\n+\tvar method = \"create\"\n+\tlog := d.Log.WithValues(\"kind\", options.Kind, \"method\", method)\n+\tctx = klog.NewContext(ctx, log)\n \n+\tstartStorage := time.Now()\n \tcreated, err := d.Storage.Create(ctx, obj, createValidation, options)\n \tif err != nil {\n \t\tlog.Error(err, \"unable to create object in storage\")\n+\t\td.recordLegacyDuration(true, mode3Str, options.Kind, method, startStorage)\n \t\treturn created, err\n \t}\n+\td.recordStorageDuration(false, mode3Str, options.Kind, method, startStorage)\n \n-\tif _, err := d.Legacy.Create(ctx, obj, createValidation, options); err != nil {\n-\t\tlog.WithValues(\"object\", created).Error(err, \"unable to create object in legacy storage\")\n-\t}\n-\treturn created, nil\n+\tgo func() {\n+\t\tctx, cancel := context.WithTimeoutCause(ctx, time.Second*10, errors.New(\"legacy create timeout\"))\n+\t\tdefer cancel()\n+\n+\t\tstartLegacy := time.Now()\n+\t\t_, errObjectSt := d.Legacy.Create(ctx, obj, createValidation, options)\n+\t\td.recordLegacyDuration(errObjectSt != nil, mode3Str, options.Kind, method, startLegacy)\n+\t}()\n+\n+\treturn created, err\n }\n \n // Get overrides the behavior of the generic DualWriter and retrieves an object from Storage.\n func (d *DualWriterMode3) Get(ctx context.Context, name string, options *metav1.GetOptions) (runtime.Object, error) {\n-\treturn d.Storage.Get(ctx, name, &metav1.GetOptions{})\n+\tvar method = \"get\"\n+\tlog := d.Log.WithValues(\"kind\", options.Kind, \"name\", name, \"method\", method)\n+\tctx = klog.NewContext(ctx, log)\n+\n+\tstartStorage := time.Now()\n+\tres, err := d.Storage.Get(ctx, name, options)\n+\tif err != nil {\n+\t\tlog.Error(err, \"unable to get object in storage\")\n+\t}\n+\td.recordStorageDuration(err != nil, mode3Str, options.Kind, method, startStorage)\n+\n+\treturn res, err\n }\n \n-func (d *DualWriterMode3) Delete(ctx context.Context, name string, deleteValidation rest.ValidateObjectFunc, options *metav1.DeleteOptions) (runtime.Object, bool, error) {\n-\tlog := d.Log.WithValues(\"name\", name)\n+// List overrides the behavior of the generic DualWriter and reads only from Unified Store.\n+func (d *DualWriterMode3) List(ctx context.Context, options *metainternalversion.ListOptions) (runtime.Object, error) {\n+\tvar method = \"list\"\n+\tlog := d.Log.WithValues(\"kind\", options.Kind, \"resourceVersion\", options.ResourceVersion, \"method\", method)\n \tctx = klog.NewContext(ctx, log)\n \n-\tdeleted, async, err := d.Storage.Delete(ctx, name, deleteValidation, options)\n+\tstartStorage := time.Now()\n+\tres, err := d.Storage.List(ctx, options)\n \tif err != nil {\n-\t\tif !apierrors.IsNotFound(err) {\n-\t\t\tlog.Error(err, \"could not delete from unified store\")\n-\t\t\treturn deleted, async, err\n-\t\t}\n+\t\tlog.Error(err, \"unable to list object in storage\")\n \t}\n+\td.recordStorageDuration(err != nil, mode3Str, options.Kind, method, startStorage)\n \n-\t_, _, errLS := d.Legacy.Delete(ctx, name, deleteValidation, options)\n-\tif errLS != nil {\n-\t\tif !apierrors.IsNotFound(errLS) {\n-\t\t\tlog.WithValues(\"deleted\", deleted).Error(errLS, \"could not delete from legacy store\")\n-\t\t}\n+\treturn res, err\n+}\n+\n+func (d *DualWriterMode3) Delete(ctx context.Context, name string, deleteValidation rest.ValidateObjectFunc, options *metav1.DeleteOptions) (runtime.Object, bool, error) {\n+\tvar method = \"delete\"\n+\tlog := d.Log.WithValues(\"name\", name, \"kind\", options.Kind, \"method\", method)\n+\tctx = klog.NewContext(ctx, d.Log)\n+\n+\tstartStorage := time.Now()\n+\tres, async, err := d.Storage.Delete(ctx, name, deleteValidation, options)\n+\tif err != nil {\n+\t\tlog.Error(err, \"unable to delete object in storage\")\n+\t\td.recordStorageDuration(true, mode3Str, options.Kind, method, startStorage)\n+\t\treturn res, async, err\n \t}\n+\td.recordStorageDuration(false, mode3Str, name, method, startStorage)\n \n-\treturn deleted, async, err\n+\tgo func() {\n+\t\tstartLegacy := time.Now()\n+\t\tctx, cancel := context.WithTimeoutCause(ctx, time.Second*10, errors.New(\"legacy delete timeout\"))\n+\t\tdefer cancel()\n+\t\t_, _, err := d.Legacy.Delete(ctx, name, deleteValidation, options)\n+\t\td.recordLegacyDuration(err != nil, mode3Str, options.Kind, method, startLegacy)\n+\t}()\n+\n+\treturn res, async, err\n }\n \n // Update overrides the behavior of the generic DualWriter and writes first to Storage and then to LegacyStorage.\n func (d *DualWriterMode3) Update(ctx context.Context, name string, objInfo rest.UpdatedObjectInfo, createValidation rest.ValidateObjectFunc, updateValidation rest.ValidateObjectUpdateFunc, forceAllowCreate bool, options *metav1.UpdateOptions) (runtime.Object, bool, error) {\n-\tlog := d.Log.WithValues(\"name\", name)\n+\tvar method = \"update\"\n+\tlog := d.Log.WithValues(\"name\", name, \"kind\", options.Kind, \"method\", method)\n \tctx = klog.NewContext(ctx, log)\n-\told, err := d.Storage.Get(ctx, name, &metav1.GetOptions{})\n-\tif err != nil {\n-\t\tlog.WithValues(\"object\", old).Error(err, \"could not get object to update\")\n-\t\treturn nil, false, err\n-\t}\n \n-\tupdated, err := objInfo.UpdatedObject(ctx, old)\n+\tstartStorage := time.Now()\n+\tres, async, err := d.Storage.Update(ctx, name, objInfo, createValidation, updateValidation, forceAllowCreate, options)\n \tif err != nil {\n-\t\tlog.WithValues(\"object\", updated).Error(err, \"could not update or create object\")\n-\t\treturn nil, false, err\n-\t}\n-\tobjInfo = &updateWrapper{\n-\t\tupstream: objInfo,\n-\t\tupdated:  updated,\n+\t\tlog.Error(err, \"unable to update in storage\")\n+\t\td.recordLegacyDuration(true, mode3Str, options.Kind, method, startStorage)\n+\t\treturn res, async, err\n \t}\n+\td.recordStorageDuration(false, mode3Str, options.Kind, method, startStorage)\n \n-\tobj, created, err := d.Storage.Update(ctx, name, objInfo, createValidation, updateValidation, forceAllowCreate, options)\n-\tif err != nil {\n-\t\tlog.WithValues(\"object\", obj).Error(err, \"could not write to US\")\n-\t\treturn obj, created, err\n-\t}\n+\tgo func() {\n+\t\tctx, cancel := context.WithTimeoutCause(ctx, time.Second*10, errors.New(\"legacy update timeout\"))\n \n-\t_, _, errLeg := d.Legacy.Update(ctx, name, &updateWrapper{\n-\t\tupstream: objInfo,\n-\t\tupdated:  obj,\n-\t}, createValidation, updateValidation, forceAllowCreate, options)\n-\tif errLeg != nil {\n-\t\tlog.Error(errLeg, \"could not update object in legacy store\")\n-\t}\n-\treturn obj, created, err\n+\t\tstartLegacy := time.Now()\n+\t\tdefer cancel()\n+\t\t_, _, errObjectSt := d.Legacy.Update(ctx, name, objInfo, createValidation, updateValidation, forceAllowCreate, options)\n+\t\td.recordLegacyDuration(errObjectSt != nil, mode3Str, options.Kind, method, startLegacy)\n+\t}()\n+\n+\treturn res, async, err\n }\n \n // DeleteCollection overrides the behavior of the generic DualWriter and deletes from both LegacyStorage and Storage.\n func (d *DualWriterMode3) DeleteCollection(ctx context.Context, deleteValidation rest.ValidateObjectFunc, options *metav1.DeleteOptions, listOptions *metainternalversion.ListOptions) (runtime.Object, error) {\n-\tlog := d.Log.WithValues(\"kind\", options.Kind, \"resourceVersion\", listOptions.ResourceVersion)\n+\tvar method = \"delete-collection\"\n+\tlog := d.Log.WithValues(\"kind\", options.Kind, \"resourceVersion\", listOptions.ResourceVersion, \"method\", method)\n \tctx = klog.NewContext(ctx, log)\n \n-\tdeleted, err := d.Storage.DeleteCollection(ctx, deleteValidation, options, listOptions)\n+\tstartStorage := time.Now()\n+\tres, err := d.Storage.DeleteCollection(ctx, deleteValidation, options, listOptions)\n \tif err != nil {\n-\t\tlog.Error(err, \"failed to delete collection successfully from Storage\")\n+\t\tlog.Error(err, \"unable to delete collection in storage\")\n+\t\td.recordStorageDuration(true, mode3Str, options.Kind, method, startStorage)\n+\t\treturn res, err\n \t}\n+\td.recordStorageDuration(false, mode3Str, options.Kind, method, startStorage)\n \n-\tif deleted, err := d.Legacy.DeleteCollection(ctx, deleteValidation, options, listOptions); err != nil {\n-\t\tlog.WithValues(\"deleted\", deleted).Error(err, \"failed to delete collection successfully from LegacyStorage\")\n-\t}\n+\tgo func() {\n+\t\tstartLegacy := time.Now()\n+\t\tctx, cancel := context.WithTimeoutCause(ctx, time.Second*10, errors.New(\"legacy deletecollection timeout\"))\n+\t\tdefer cancel()\n+\t\t_, err := d.Legacy.DeleteCollection(ctx, deleteValidation, options, listOptions)\n+\t\td.recordStorageDuration(err != nil, mode3Str, options.Kind, method, startLegacy)","path":"pkg/apiserver/rest/dualwriter_mode3.go","commit_id":"67b74e1e8a7d26d24617b7313b90fa4649138318","original_commit_id":"67b74e1e8a7d26d24617b7313b90fa4649138318","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"**[P1] Record legacy metrics with recordLegacyDuration (not storage)**\n\nIn the legacy `DeleteCollection` goroutine you're calling `recordStorageDuration(...)` even though it's measuring the legacy delete; this will mislabel metrics and break dashboards/alerts.","created_at":"2026-01-16T19:41:30Z","updated_at":"2026-01-16T19:41:30Z","html_url":"https://github.com/droid-code-review-evals/droid-grafana/pull/6#discussion_r2699751049","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/6","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/comments/2699751049"},"html":{"href":"https://github.com/droid-code-review-evals/droid-grafana/pull/6#discussion_r2699751049"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/6"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/comments/2699751049/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":166,"original_line":166,"side":"RIGHT","author_association":"NONE","original_position":208,"position":208,"subject_type":"line"},{"url":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/comments/2699751215","pull_request_review_id":3672447474,"id":2699751215,"node_id":"PRRC_kwDOQ4pSe86g6u8v","diff_hunk":"@@ -21,114 +22,151 @@ type DualWriterMode3 struct {\n // newDualWriterMode3 returns a new DualWriter in mode 3.\n // Mode 3 represents writing to LegacyStorage and Storage and reading from Storage.\n func newDualWriterMode3(legacy LegacyStorage, storage Storage, dwm *dualWriterMetrics) *DualWriterMode3 {\n-\treturn &DualWriterMode3{Legacy: legacy, Storage: storage, Log: klog.NewKlogr().WithName(\"DualWriterMode3\"), dualWriterMetrics: dwm}\n+\treturn &DualWriterMode3{Legacy: legacy, Storage: storage, Log: klog.NewKlogr().WithName(\"DualWriterMode3\").WithValues(\"mode\", mode3Str), dualWriterMetrics: dwm}\n }\n \n // Mode returns the mode of the dual writer.\n func (d *DualWriterMode3) Mode() DualWriterMode {\n \treturn Mode3\n }\n \n+const mode3Str = \"3\"\n+\n // Create overrides the behavior of the generic DualWriter and writes to LegacyStorage and Storage.\n func (d *DualWriterMode3) Create(ctx context.Context, obj runtime.Object, createValidation rest.ValidateObjectFunc, options *metav1.CreateOptions) (runtime.Object, error) {\n-\tlog := klog.FromContext(ctx)\n+\tvar method = \"create\"\n+\tlog := d.Log.WithValues(\"kind\", options.Kind, \"method\", method)\n+\tctx = klog.NewContext(ctx, log)\n \n+\tstartStorage := time.Now()\n \tcreated, err := d.Storage.Create(ctx, obj, createValidation, options)\n \tif err != nil {\n \t\tlog.Error(err, \"unable to create object in storage\")\n+\t\td.recordLegacyDuration(true, mode3Str, options.Kind, method, startStorage)","path":"pkg/apiserver/rest/dualwriter_mode3.go","commit_id":"67b74e1e8a7d26d24617b7313b90fa4649138318","original_commit_id":"67b74e1e8a7d26d24617b7313b90fa4649138318","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"**[P2] Record create failure with recordStorageDuration, not legacy**\n\nOn storage `Create` failure you call `recordLegacyDuration(...)` even though legacy hasn't run; this produces incorrect error attribution in metrics.","created_at":"2026-01-16T19:41:34Z","updated_at":"2026-01-16T19:41:34Z","html_url":"https://github.com/droid-code-review-evals/droid-grafana/pull/6#discussion_r2699751215","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/6","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/comments/2699751215"},"html":{"href":"https://github.com/droid-code-review-evals/droid-grafana/pull/6#discussion_r2699751215"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/6"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/comments/2699751215/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":45,"original_line":45,"side":"RIGHT","author_association":"NONE","original_position":37,"position":37,"subject_type":"line"},{"url":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/comments/2699751484","pull_request_review_id":3672447982,"id":2699751484,"node_id":"PRRC_kwDOQ4pSe86g6vA8","diff_hunk":"@@ -21,114 +22,151 @@ type DualWriterMode3 struct {\n // newDualWriterMode3 returns a new DualWriter in mode 3.\n // Mode 3 represents writing to LegacyStorage and Storage and reading from Storage.\n func newDualWriterMode3(legacy LegacyStorage, storage Storage, dwm *dualWriterMetrics) *DualWriterMode3 {\n-\treturn &DualWriterMode3{Legacy: legacy, Storage: storage, Log: klog.NewKlogr().WithName(\"DualWriterMode3\"), dualWriterMetrics: dwm}\n+\treturn &DualWriterMode3{Legacy: legacy, Storage: storage, Log: klog.NewKlogr().WithName(\"DualWriterMode3\").WithValues(\"mode\", mode3Str), dualWriterMetrics: dwm}\n }\n \n // Mode returns the mode of the dual writer.\n func (d *DualWriterMode3) Mode() DualWriterMode {\n \treturn Mode3\n }\n \n+const mode3Str = \"3\"\n+\n // Create overrides the behavior of the generic DualWriter and writes to LegacyStorage and Storage.\n func (d *DualWriterMode3) Create(ctx context.Context, obj runtime.Object, createValidation rest.ValidateObjectFunc, options *metav1.CreateOptions) (runtime.Object, error) {\n-\tlog := klog.FromContext(ctx)\n+\tvar method = \"create\"\n+\tlog := d.Log.WithValues(\"kind\", options.Kind, \"method\", method)\n+\tctx = klog.NewContext(ctx, log)\n \n+\tstartStorage := time.Now()\n \tcreated, err := d.Storage.Create(ctx, obj, createValidation, options)\n \tif err != nil {\n \t\tlog.Error(err, \"unable to create object in storage\")\n+\t\td.recordLegacyDuration(true, mode3Str, options.Kind, method, startStorage)\n \t\treturn created, err\n \t}\n+\td.recordStorageDuration(false, mode3Str, options.Kind, method, startStorage)\n \n-\tif _, err := d.Legacy.Create(ctx, obj, createValidation, options); err != nil {\n-\t\tlog.WithValues(\"object\", created).Error(err, \"unable to create object in legacy storage\")\n-\t}\n-\treturn created, nil\n+\tgo func() {\n+\t\tctx, cancel := context.WithTimeoutCause(ctx, time.Second*10, errors.New(\"legacy create timeout\"))\n+\t\tdefer cancel()\n+\n+\t\tstartLegacy := time.Now()\n+\t\t_, errObjectSt := d.Legacy.Create(ctx, obj, createValidation, options)\n+\t\td.recordLegacyDuration(errObjectSt != nil, mode3Str, options.Kind, method, startLegacy)\n+\t}()\n+\n+\treturn created, err\n }\n \n // Get overrides the behavior of the generic DualWriter and retrieves an object from Storage.\n func (d *DualWriterMode3) Get(ctx context.Context, name string, options *metav1.GetOptions) (runtime.Object, error) {\n-\treturn d.Storage.Get(ctx, name, &metav1.GetOptions{})\n+\tvar method = \"get\"\n+\tlog := d.Log.WithValues(\"kind\", options.Kind, \"name\", name, \"method\", method)\n+\tctx = klog.NewContext(ctx, log)\n+\n+\tstartStorage := time.Now()\n+\tres, err := d.Storage.Get(ctx, name, options)\n+\tif err != nil {\n+\t\tlog.Error(err, \"unable to get object in storage\")\n+\t}\n+\td.recordStorageDuration(err != nil, mode3Str, options.Kind, method, startStorage)\n+\n+\treturn res, err\n }\n \n-func (d *DualWriterMode3) Delete(ctx context.Context, name string, deleteValidation rest.ValidateObjectFunc, options *metav1.DeleteOptions) (runtime.Object, bool, error) {\n-\tlog := d.Log.WithValues(\"name\", name)\n+// List overrides the behavior of the generic DualWriter and reads only from Unified Store.\n+func (d *DualWriterMode3) List(ctx context.Context, options *metainternalversion.ListOptions) (runtime.Object, error) {\n+\tvar method = \"list\"\n+\tlog := d.Log.WithValues(\"kind\", options.Kind, \"resourceVersion\", options.ResourceVersion, \"method\", method)\n \tctx = klog.NewContext(ctx, log)\n \n-\tdeleted, async, err := d.Storage.Delete(ctx, name, deleteValidation, options)\n+\tstartStorage := time.Now()\n+\tres, err := d.Storage.List(ctx, options)\n \tif err != nil {\n-\t\tif !apierrors.IsNotFound(err) {\n-\t\t\tlog.Error(err, \"could not delete from unified store\")\n-\t\t\treturn deleted, async, err\n-\t\t}\n+\t\tlog.Error(err, \"unable to list object in storage\")\n \t}\n+\td.recordStorageDuration(err != nil, mode3Str, options.Kind, method, startStorage)\n \n-\t_, _, errLS := d.Legacy.Delete(ctx, name, deleteValidation, options)\n-\tif errLS != nil {\n-\t\tif !apierrors.IsNotFound(errLS) {\n-\t\t\tlog.WithValues(\"deleted\", deleted).Error(errLS, \"could not delete from legacy store\")\n-\t\t}\n+\treturn res, err\n+}\n+\n+func (d *DualWriterMode3) Delete(ctx context.Context, name string, deleteValidation rest.ValidateObjectFunc, options *metav1.DeleteOptions) (runtime.Object, bool, error) {\n+\tvar method = \"delete\"\n+\tlog := d.Log.WithValues(\"name\", name, \"kind\", options.Kind, \"method\", method)\n+\tctx = klog.NewContext(ctx, d.Log)\n+\n+\tstartStorage := time.Now()\n+\tres, async, err := d.Storage.Delete(ctx, name, deleteValidation, options)\n+\tif err != nil {\n+\t\tlog.Error(err, \"unable to delete object in storage\")\n+\t\td.recordStorageDuration(true, mode3Str, options.Kind, method, startStorage)\n+\t\treturn res, async, err\n \t}\n+\td.recordStorageDuration(false, mode3Str, name, method, startStorage)","path":"pkg/apiserver/rest/dualwriter_mode3.go","commit_id":"67b74e1e8a7d26d24617b7313b90fa4649138318","original_commit_id":"67b74e1e8a7d26d24617b7313b90fa4649138318","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"**[P2] Use kind (not name) for storage metric label on delete success**\n\n`recordStorageDuration(false, ..., name, ...)` labels the metric with the object name, which will explode cardinality; it should use `options.Kind` like the other calls.","created_at":"2026-01-16T19:41:40Z","updated_at":"2026-01-16T19:41:40Z","html_url":"https://github.com/droid-code-review-evals/droid-grafana/pull/6#discussion_r2699751484","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/6","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/comments/2699751484"},"html":{"href":"https://github.com/droid-code-review-evals/droid-grafana/pull/6#discussion_r2699751484"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/6"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/comments/2699751484/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":106,"original_line":106,"side":"RIGHT","author_association":"NONE","original_position":115,"position":115,"subject_type":"line"},{"url":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/comments/2699751702","pull_request_review_id":3672448381,"id":2699751702,"node_id":"PRRC_kwDOQ4pSe86g6vEW","diff_hunk":"@@ -21,114 +22,151 @@ type DualWriterMode3 struct {\n // newDualWriterMode3 returns a new DualWriter in mode 3.\n // Mode 3 represents writing to LegacyStorage and Storage and reading from Storage.\n func newDualWriterMode3(legacy LegacyStorage, storage Storage, dwm *dualWriterMetrics) *DualWriterMode3 {\n-\treturn &DualWriterMode3{Legacy: legacy, Storage: storage, Log: klog.NewKlogr().WithName(\"DualWriterMode3\"), dualWriterMetrics: dwm}\n+\treturn &DualWriterMode3{Legacy: legacy, Storage: storage, Log: klog.NewKlogr().WithName(\"DualWriterMode3\").WithValues(\"mode\", mode3Str), dualWriterMetrics: dwm}\n }\n \n // Mode returns the mode of the dual writer.\n func (d *DualWriterMode3) Mode() DualWriterMode {\n \treturn Mode3\n }\n \n+const mode3Str = \"3\"\n+\n // Create overrides the behavior of the generic DualWriter and writes to LegacyStorage and Storage.\n func (d *DualWriterMode3) Create(ctx context.Context, obj runtime.Object, createValidation rest.ValidateObjectFunc, options *metav1.CreateOptions) (runtime.Object, error) {\n-\tlog := klog.FromContext(ctx)\n+\tvar method = \"create\"\n+\tlog := d.Log.WithValues(\"kind\", options.Kind, \"method\", method)\n+\tctx = klog.NewContext(ctx, log)\n \n+\tstartStorage := time.Now()\n \tcreated, err := d.Storage.Create(ctx, obj, createValidation, options)\n \tif err != nil {\n \t\tlog.Error(err, \"unable to create object in storage\")\n+\t\td.recordLegacyDuration(true, mode3Str, options.Kind, method, startStorage)\n \t\treturn created, err\n \t}\n+\td.recordStorageDuration(false, mode3Str, options.Kind, method, startStorage)\n \n-\tif _, err := d.Legacy.Create(ctx, obj, createValidation, options); err != nil {\n-\t\tlog.WithValues(\"object\", created).Error(err, \"unable to create object in legacy storage\")\n-\t}\n-\treturn created, nil\n+\tgo func() {\n+\t\tctx, cancel := context.WithTimeoutCause(ctx, time.Second*10, errors.New(\"legacy create timeout\"))\n+\t\tdefer cancel()\n+\n+\t\tstartLegacy := time.Now()\n+\t\t_, errObjectSt := d.Legacy.Create(ctx, obj, createValidation, options)\n+\t\td.recordLegacyDuration(errObjectSt != nil, mode3Str, options.Kind, method, startLegacy)\n+\t}()\n+\n+\treturn created, err\n }\n \n // Get overrides the behavior of the generic DualWriter and retrieves an object from Storage.\n func (d *DualWriterMode3) Get(ctx context.Context, name string, options *metav1.GetOptions) (runtime.Object, error) {\n-\treturn d.Storage.Get(ctx, name, &metav1.GetOptions{})\n+\tvar method = \"get\"\n+\tlog := d.Log.WithValues(\"kind\", options.Kind, \"name\", name, \"method\", method)\n+\tctx = klog.NewContext(ctx, log)\n+\n+\tstartStorage := time.Now()\n+\tres, err := d.Storage.Get(ctx, name, options)\n+\tif err != nil {\n+\t\tlog.Error(err, \"unable to get object in storage\")\n+\t}\n+\td.recordStorageDuration(err != nil, mode3Str, options.Kind, method, startStorage)\n+\n+\treturn res, err\n }\n \n-func (d *DualWriterMode3) Delete(ctx context.Context, name string, deleteValidation rest.ValidateObjectFunc, options *metav1.DeleteOptions) (runtime.Object, bool, error) {\n-\tlog := d.Log.WithValues(\"name\", name)\n+// List overrides the behavior of the generic DualWriter and reads only from Unified Store.\n+func (d *DualWriterMode3) List(ctx context.Context, options *metainternalversion.ListOptions) (runtime.Object, error) {\n+\tvar method = \"list\"\n+\tlog := d.Log.WithValues(\"kind\", options.Kind, \"resourceVersion\", options.ResourceVersion, \"method\", method)\n \tctx = klog.NewContext(ctx, log)\n \n-\tdeleted, async, err := d.Storage.Delete(ctx, name, deleteValidation, options)\n+\tstartStorage := time.Now()\n+\tres, err := d.Storage.List(ctx, options)\n \tif err != nil {\n-\t\tif !apierrors.IsNotFound(err) {\n-\t\t\tlog.Error(err, \"could not delete from unified store\")\n-\t\t\treturn deleted, async, err\n-\t\t}\n+\t\tlog.Error(err, \"unable to list object in storage\")\n \t}\n+\td.recordStorageDuration(err != nil, mode3Str, options.Kind, method, startStorage)\n \n-\t_, _, errLS := d.Legacy.Delete(ctx, name, deleteValidation, options)\n-\tif errLS != nil {\n-\t\tif !apierrors.IsNotFound(errLS) {\n-\t\t\tlog.WithValues(\"deleted\", deleted).Error(errLS, \"could not delete from legacy store\")\n-\t\t}\n+\treturn res, err\n+}\n+\n+func (d *DualWriterMode3) Delete(ctx context.Context, name string, deleteValidation rest.ValidateObjectFunc, options *metav1.DeleteOptions) (runtime.Object, bool, error) {\n+\tvar method = \"delete\"\n+\tlog := d.Log.WithValues(\"name\", name, \"kind\", options.Kind, \"method\", method)\n+\tctx = klog.NewContext(ctx, d.Log)\n+\n+\tstartStorage := time.Now()\n+\tres, async, err := d.Storage.Delete(ctx, name, deleteValidation, options)\n+\tif err != nil {\n+\t\tlog.Error(err, \"unable to delete object in storage\")\n+\t\td.recordStorageDuration(true, mode3Str, options.Kind, method, startStorage)\n+\t\treturn res, async, err\n \t}\n+\td.recordStorageDuration(false, mode3Str, name, method, startStorage)\n \n-\treturn deleted, async, err\n+\tgo func() {\n+\t\tstartLegacy := time.Now()\n+\t\tctx, cancel := context.WithTimeoutCause(ctx, time.Second*10, errors.New(\"legacy delete timeout\"))\n+\t\tdefer cancel()\n+\t\t_, _, err := d.Legacy.Delete(ctx, name, deleteValidation, options)\n+\t\td.recordLegacyDuration(err != nil, mode3Str, options.Kind, method, startLegacy)\n+\t}()\n+\n+\treturn res, async, err\n }\n \n // Update overrides the behavior of the generic DualWriter and writes first to Storage and then to LegacyStorage.\n func (d *DualWriterMode3) Update(ctx context.Context, name string, objInfo rest.UpdatedObjectInfo, createValidation rest.ValidateObjectFunc, updateValidation rest.ValidateObjectUpdateFunc, forceAllowCreate bool, options *metav1.UpdateOptions) (runtime.Object, bool, error) {\n-\tlog := d.Log.WithValues(\"name\", name)\n+\tvar method = \"update\"\n+\tlog := d.Log.WithValues(\"name\", name, \"kind\", options.Kind, \"method\", method)\n \tctx = klog.NewContext(ctx, log)\n-\told, err := d.Storage.Get(ctx, name, &metav1.GetOptions{})\n-\tif err != nil {\n-\t\tlog.WithValues(\"object\", old).Error(err, \"could not get object to update\")\n-\t\treturn nil, false, err\n-\t}\n \n-\tupdated, err := objInfo.UpdatedObject(ctx, old)\n+\tstartStorage := time.Now()\n+\tres, async, err := d.Storage.Update(ctx, name, objInfo, createValidation, updateValidation, forceAllowCreate, options)\n \tif err != nil {\n-\t\tlog.WithValues(\"object\", updated).Error(err, \"could not update or create object\")\n-\t\treturn nil, false, err\n-\t}\n-\tobjInfo = &updateWrapper{\n-\t\tupstream: objInfo,\n-\t\tupdated:  updated,\n+\t\tlog.Error(err, \"unable to update in storage\")\n+\t\td.recordLegacyDuration(true, mode3Str, options.Kind, method, startStorage)","path":"pkg/apiserver/rest/dualwriter_mode3.go","commit_id":"67b74e1e8a7d26d24617b7313b90fa4649138318","original_commit_id":"67b74e1e8a7d26d24617b7313b90fa4649138318","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"**[P2] Record update failure with recordStorageDuration, not legacy**\n\nOn storage `Update` error you call `recordLegacyDuration(...)` using the storage timing; legacy hasn't executed yet, so this misreports which backend failed.","created_at":"2026-01-16T19:41:45Z","updated_at":"2026-01-16T19:41:45Z","html_url":"https://github.com/droid-code-review-evals/droid-grafana/pull/6#discussion_r2699751702","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/6","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/comments/2699751702"},"html":{"href":"https://github.com/droid-code-review-evals/droid-grafana/pull/6#discussion_r2699751702"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/6"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/comments/2699751702/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":129,"original_line":129,"side":"RIGHT","author_association":"NONE","original_position":152,"position":152,"subject_type":"line"}]
[{"url":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/comments/2699749785","pull_request_review_id":3672445077,"id":2699749785,"node_id":"PRRC_kwDOQ4pSe86g6umZ","diff_hunk":"@@ -65,9 +69,54 @@ func (s *AnonDBStore) ListDevices(ctx context.Context, from *time.Time, to *time\n \treturn devices, err\n }\n \n+// updateDevice updates a device if it exists and has been updated between the given times.\n+func (s *AnonDBStore) updateDevice(ctx context.Context, device *Device) error {\n+\tconst query = `UPDATE anon_device SET\n+client_ip = ?,\n+user_agent = ?,\n+updated_at = ?\n+WHERE device_id = ? AND updated_at BETWEEN ? AND ?`\n+\n+\targs := []interface{}{device.ClientIP, device.UserAgent, device.UpdatedAt.UTC(), device.DeviceID,\n+\t\tdevice.UpdatedAt.UTC().Add(-anonymousDeviceExpiration), device.UpdatedAt.UTC().Add(time.Minute),\n+\t}\n+\terr := s.sqlStore.WithDbSession(ctx, func(dbSession *sqlstore.DBSession) error {\n+\t\targs = append([]interface{}{query}, args...)\n+\t\tresult, err := dbSession.Exec(args...)\n+\t\tif err != nil {\n+\t\t\treturn err\n+\t\t}\n+\n+\t\trowsAffected, err := result.RowsAffected()\n+\t\tif err != nil {\n+\t\t\treturn err\n+\t\t}\n+\n+\t\tif rowsAffected == 0 {\n+\t\t\treturn ErrDeviceLimitReached","path":"pkg/services/anonymous/anonimpl/anonstore/database.go","commit_id":"3647ba7360b8d157e4a294a650a365b6aca070d8","original_commit_id":"3647ba7360b8d157e4a294a650a365b6aca070d8","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"**[P1] Don’t return `ErrDeviceLimitReached` when update hits zero rows**\n\n`updateDevice` returns `ErrDeviceLimitReached` when `rowsAffected == 0`, but that also happens when the `device_id` doesn’t exist (common when limit is reached and a *new* device tries to register). This conflates “device not found/expired” with “limit reached” and will reject all new devices once the limit is hit rather than allowing an explicit/accurate error (or different handling) based on existence.","created_at":"2026-01-16T19:41:01Z","updated_at":"2026-01-16T19:41:01Z","html_url":"https://github.com/droid-code-review-evals/droid-grafana/pull/1#discussion_r2699749785","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/1","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/comments/2699749785"},"html":{"href":"https://github.com/droid-code-review-evals/droid-grafana/pull/1#discussion_r2699749785"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/1"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/comments/2699749785/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":96,"original_line":96,"side":"RIGHT","author_association":"NONE","original_position":56,"position":56,"subject_type":"line"},{"url":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/comments/2699749987","pull_request_review_id":3672445384,"id":2699749987,"node_id":"PRRC_kwDOQ4pSe86g6upj","diff_hunk":"@@ -42,19 +41,13 @@ func (a *Anonymous) Authenticate(ctx context.Context, r *authn.Request) (*authn.\n \t\thttpReqCopy.RemoteAddr = r.HTTPRequest.RemoteAddr\n \t}\n \n-\tgo func() {\n-\t\tdefer func() {\n-\t\t\tif err := recover(); err != nil {\n-\t\t\t\ta.log.Warn(\"Tag anon session panic\", \"err\", err)\n-\t\t\t}\n-\t\t}()\n-\n-\t\tnewCtx, cancel := context.WithTimeout(context.Background(), timeoutTag)\n-\t\tdefer cancel()\n-\t\tif err := a.anonDeviceService.TagDevice(newCtx, httpReqCopy, anonymous.AnonDeviceUI); err != nil {\n-\t\t\ta.log.Warn(\"Failed to tag anonymous session\", \"error\", err)\n+\tif err := a.anonDeviceService.TagDevice(ctx, httpReqCopy, anonymous.AnonDeviceUI); err != nil {\n+\t\tif errors.Is(err, anonstore.ErrDeviceLimitReached) {","path":"pkg/services/anonymous/anonimpl/client.go","commit_id":"3647ba7360b8d157e4a294a650a365b6aca070d8","original_commit_id":"3647ba7360b8d157e4a294a650a365b6aca070d8","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"**[P0] Avoid turning device limit into auth failure (DoS risk)**\n\n`Authenticate` now returns an error when `TagDevice` hits `ErrDeviceLimitReached`, which can block anonymous auth for any new device once the limit is reached. If tagging is meant to be best-effort telemetry/state, this becomes a hard outage for anonymous users at capacity; handle this without failing authentication unless the product explicitly intends to deny access.","created_at":"2026-01-16T19:41:06Z","updated_at":"2026-01-16T19:41:06Z","html_url":"https://github.com/droid-code-review-evals/droid-grafana/pull/1#discussion_r2699749987","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/1","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/comments/2699749987"},"html":{"href":"https://github.com/droid-code-review-evals/droid-grafana/pull/1#discussion_r2699749987"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/1"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/comments/2699749987/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":45,"original_line":45,"side":"RIGHT","author_association":"NONE","original_position":40,"position":40,"subject_type":"line"},{"url":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/comments/2699750229","pull_request_review_id":3672445723,"id":2699750229,"node_id":"PRRC_kwDOQ4pSe86g6utV","diff_hunk":"@@ -143,6 +144,7 @@ func (a *AnonDeviceService) TagDevice(ctx context.Context, httpReq *http.Request\n \terr = a.tagDeviceUI(ctx, httpReq, taggedDevice)\n \tif err != nil {\n \t\ta.log.Debug(\"Failed to tag device for UI\", \"error\", err)","path":"pkg/services/anonymous/anonimpl/impl.go","commit_id":"3647ba7360b8d157e4a294a650a365b6aca070d8","original_commit_id":"3647ba7360b8d157e4a294a650a365b6aca070d8","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"**[P1] Preserve previous behavior by not returning tagging errors directly**\n\n`TagDevice` now returns the error from `tagDeviceUI`, but `Authenticate` previously ran tagging asynchronously and never failed the request. With this change, transient DB/cache errors (and now device-limit) can bubble up and change the auth contract; if the intent is only to enforce limit, consider returning only that specific error or keeping tagging non-fatal.","created_at":"2026-01-16T19:41:11Z","updated_at":"2026-01-16T19:41:11Z","html_url":"https://github.com/droid-code-review-evals/droid-grafana/pull/1#discussion_r2699750229","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/1","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/comments/2699750229"},"html":{"href":"https://github.com/droid-code-review-evals/droid-grafana/pull/1#discussion_r2699750229"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/1"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/comments/2699750229/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":146,"original_line":146,"side":"RIGHT","author_association":"NONE","original_position":36,"position":36,"subject_type":"line"}]
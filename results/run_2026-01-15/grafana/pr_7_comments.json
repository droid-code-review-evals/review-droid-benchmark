[{"url":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/comments/2699750410","pull_request_review_id":3672446172,"id":2699750410,"node_id":"PRRC_kwDOQ4pSe86g6uwK","diff_hunk":"@@ -519,52 +520,135 @@ func (r *xormRepositoryImpl) CleanAnnotations(ctx context.Context, cfg setting.A\n \tvar totalAffected int64\n \tif cfg.MaxAge > 0 {\n \t\tcutoffDate := timeNow().Add(-cfg.MaxAge).UnixNano() / int64(time.Millisecond)\n-\t\tdeleteQuery := `DELETE FROM annotation WHERE id IN (SELECT id FROM (SELECT id FROM annotation WHERE %s AND created < %v ORDER BY id DESC %s) a)`\n-\t\tsql := fmt.Sprintf(deleteQuery, annotationType, cutoffDate, r.db.GetDialect().Limit(r.cfg.AnnotationCleanupJobBatchSize))\n+\t\t// Single-statement approaches, specifically ones using batched sub-queries, seem to deadlock with concurrent inserts on MySQL.\n+\t\t// We have a bounded batch size, so work around this by first loading the IDs into memory and allowing any locks to flush inside each batch.\n+\t\t// This may under-delete when concurrent inserts happen, but any such annotations will simply be cleaned on the next cycle.\n+\t\t//\n+\t\t// We execute the following batched operation repeatedly until either we run out of objects, the context is cancelled, or there is an error.\n+\t\taffected, err := untilDoneOrCancelled(ctx, func() (int64, error) {\n+\t\t\tcond := fmt.Sprintf(`%s AND created < %v ORDER BY id DESC %s`, annotationType, cutoffDate, r.db.GetDialect().Limit(r.cfg.AnnotationCleanupJobBatchSize))\n+\t\t\tids, err := r.fetchIDs(ctx, \"annotation\", cond)\n+\t\t\tif err != nil {\n+\t\t\t\treturn 0, err\n+\t\t\t}\n+\t\t\tr.log.Error(\"Annotations to clean by time\", \"count\", len(ids), \"ids\", ids, \"cond\", cond, \"err\", err)","path":"pkg/services/annotations/annotationsimpl/xorm_store.go","commit_id":"81c45bfe449584dc7ff50e4fabd5d0c6568999b5","original_commit_id":"81c45bfe449584dc7ff50e4fabd5d0c6568999b5","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"**[P1] Remove error-level logging of annotation IDs in cleanup**\n\nThis logs full `ids` arrays at `Error` level during normal cleanup runs, which can flood logs and potentially leak internal IDs; these should be debug-level and/or omit the raw ID list.","created_at":"2026-01-16T19:41:17Z","updated_at":"2026-01-16T19:41:17Z","html_url":"https://github.com/droid-code-review-evals/droid-grafana/pull/7#discussion_r2699750410","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/7","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/comments/2699750410"},"html":{"href":"https://github.com/droid-code-review-evals/droid-grafana/pull/7#discussion_r2699750410"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/7"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/comments/2699750410/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":534,"original_line":534,"side":"RIGHT","author_association":"NONE","original_position":25,"position":25,"subject_type":"line"},{"url":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/comments/2699750610","pull_request_review_id":3672446600,"id":2699750610,"node_id":"PRRC_kwDOQ4pSe86g6uzS","diff_hunk":"@@ -74,7 +74,7 @@ func (j cleanUpJob) String() string {\n func (srv *CleanUpService) Run(ctx context.Context) error {\n \tsrv.cleanUpTmpFiles(ctx)\n \n-\tticker := time.NewTicker(time.Minute * 10)\n+\tticker := time.NewTicker(time.Minute * 1)","path":"pkg/services/cleanup/cleanup.go","commit_id":"81c45bfe449584dc7ff50e4fabd5d0c6568999b5","original_commit_id":"81c45bfe449584dc7ff50e4fabd5d0c6568999b5","user":{"login":"factory-droid[bot]","id":138933559,"node_id":"BOT_kgDOCEf1Nw","avatar_url":"https://avatars.githubusercontent.com/in/358017?v=4","gravatar_id":"","url":"https://api.github.com/users/factory-droid%5Bbot%5D","html_url":"https://github.com/apps/factory-droid","followers_url":"https://api.github.com/users/factory-droid%5Bbot%5D/followers","following_url":"https://api.github.com/users/factory-droid%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/factory-droid%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/factory-droid%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/factory-droid%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/factory-droid%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/factory-droid%5Bbot%5D/repos","events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/factory-droid%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"**[P1] Revert cleanup ticker from 10m to 1m**\n\nThis changes the cleanup loop to run 10Ã— more frequently, which can materially increase DB/filesystem load in production and looks unrelated to the deadlock fix in this PR.","created_at":"2026-01-16T19:41:22Z","updated_at":"2026-01-16T19:41:22Z","html_url":"https://github.com/droid-code-review-evals/droid-grafana/pull/7#discussion_r2699750610","pull_request_url":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/7","_links":{"self":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/comments/2699750610"},"html":{"href":"https://github.com/droid-code-review-evals/droid-grafana/pull/7#discussion_r2699750610"},"pull_request":{"href":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/7"}},"reactions":{"url":"https://api.github.com/repos/droid-code-review-evals/droid-grafana/pulls/comments/2699750610/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":77,"original_line":77,"side":"RIGHT","author_association":"NONE","original_position":5,"position":5,"subject_type":"line"}]
{
  "pr_number": 7,
  "pr_title": "OAuth credential sync and app integration enhancements",
  "revalidation_date": "2026-01-20",
  "bug_verdicts": [
    {
      "bug_id": 1,
      "original_description": "Webhook header case sensitivity - CALCOM_WEBHOOK_HEADER_NAME with uppercase chars will fail lookup",
      "file": "apps/web/pages/api/webhook/app-credential.ts",
      "line": 24,
      "original_severity": "medium",
      "original_source": "droid_only",
      "verdict": "confirmed",
      "verified_file": "apps/web/pages/api/webhook/app-credential.ts",
      "verified_line": 25,
      "verified_severity": "medium",
      "verified_bug_type": "logic_bug",
      "verified_description": "Node/Next lowercases incoming header names; indexing req.headers with a mixed/upper-case CALCOM_WEBHOOK_HEADER_NAME will miss the header and incorrectly reject valid webhook requests.",
      "notes": "Verified at apps/web/pages/api/webhook/app-credential.ts:25 (req.headers[process.env.CALCOM_WEBHOOK_HEADER_NAME || \"calcom-webhook-secret\"])."
    },
    {
      "bug_id": 2,
      "original_description": "Invalid Zod schema syntax - computed keys [z.string().toString()] don't work in z.object()",
      "file": "packages/app-store/_utils/oauth/parseRefreshTokenResponse.ts",
      "line": 7,
      "original_severity": "medium",
      "original_source": "both",
      "verdict": "confirmed",
      "verified_file": "packages/app-store/_utils/oauth/parseRefreshTokenResponse.ts",
      "verified_line": 8,
      "verified_severity": "medium",
      "verified_bug_type": "runtime_error",
      "verified_description": "minimumTokenResponseSchema uses computed object keys derived from z.string().toString(), which become fixed string keys (e.g. \"ZodString\") rather than allowing arbitrary keys; safeParse will fail for normal token responses and throw.",
      "notes": "Verified schema definition at packages/app-store/_utils/oauth/parseRefreshTokenResponse.ts:5-11."
    },
    {
      "bug_id": 3,
      "original_description": "Hardcoded 'refresh_token' string when refresh_token is missing from response",
      "file": "packages/app-store/_utils/oauth/parseRefreshTokenResponse.ts",
      "line": 26,
      "original_severity": "medium",
      "original_source": "both",
      "verdict": "confirmed",
      "verified_file": "packages/app-store/_utils/oauth/parseRefreshTokenResponse.ts",
      "verified_line": 26,
      "verified_severity": "medium",
      "verified_bug_type": "logic_bug",
      "verified_description": "When refresh_token is missing, the function sets refreshTokenResponse.data.refresh_token to the literal string \"refresh_token\", which will break subsequent refreshes and stores an invalid token.",
      "notes": "Verified at packages/app-store/_utils/oauth/parseRefreshTokenResponse.ts:25-27."
    },
    {
      "bug_id": 4,
      "original_description": "parseRefreshTokenResponse returns safeParse result {success,data,error} instead of parsed data",
      "file": "packages/app-store/_utils/oauth/parseRefreshTokenResponse.ts",
      "line": 29,
      "original_severity": "medium",
      "original_source": "both",
      "verdict": "confirmed",
      "verified_file": "packages/app-store/_utils/oauth/parseRefreshTokenResponse.ts",
      "verified_line": 29,
      "verified_severity": "high",
      "verified_bug_type": "logic_bug",
      "verified_description": "parseRefreshTokenResponse returns the Zod safeParse result object instead of the parsed token payload; callers that expect the token object may persist {success,data,error} into credential storage or treat it as a token.",
      "notes": "Verified return at packages/app-store/_utils/oauth/parseRefreshTokenResponse.ts:29. Example: GoogleCalendarService persists the returned value as the credential key."
    },
    {
      "bug_id": 5,
      "original_description": "Salesforce CalendarService missing prisma import - ReferenceError on token refresh",
      "file": "packages/app-store/salesforce/lib/CalendarService.ts",
      "line": 96,
      "original_severity": "medium",
      "original_source": "droid_only",
      "verdict": "confirmed",
      "verified_file": "packages/app-store/salesforce/lib/CalendarService.ts",
      "verified_line": 96,
      "verified_severity": "high",
      "verified_bug_type": "runtime_error",
      "verified_description": "SalesforceCalendarService calls prisma.credential.update without importing prisma in this file, causing a ReferenceError at runtime during client initialization/token refresh.",
      "notes": "Verified prisma usage at packages/app-store/salesforce/lib/CalendarService.ts:96 and no @calcom/prisma import in the file."
    },
    {
      "bug_id": 6,
      "original_description": "Salesforce uses stale credentialKey.access_token after refresh instead of refreshed token",
      "file": "packages/app-store/salesforce/lib/CalendarService.ts",
      "line": 103,
      "original_severity": "medium",
      "original_source": "droid_only",
      "verdict": "confirmed",
      "verified_file": "packages/app-store/salesforce/lib/CalendarService.ts",
      "verified_line": 106,
      "verified_severity": "medium",
      "verified_bug_type": "logic_bug",
      "verified_description": "After refreshing tokens, the jsforce.Connection is constructed with accessToken: credentialKey.access_token (stale) rather than the refreshed access token from accessTokenParsed.data.",
      "notes": "Verified at packages/app-store/salesforce/lib/CalendarService.ts:101-108."
    },
    {
      "bug_id": 7,
      "original_description": "zoho-bigin passes credentialId instead of userId to refreshOAuthTokens",
      "file": "packages/app-store/zoho-bigin/lib/CalendarService.ts",
      "line": 93,
      "original_severity": "medium",
      "original_source": "droid_only",
      "verdict": "confirmed",
      "verified_file": "packages/app-store/zoho-bigin/lib/CalendarService.ts",
      "verified_line": 93,
      "verified_severity": "medium",
      "verified_bug_type": "logic_bug",
      "verified_description": "refreshOAuthTokens expects a Cal.com userId for credential sync payloads, but Zoho Bigin passes credentialId; if sync is enabled the endpoint receives the wrong calcomUserId.",
      "notes": "Verified call site at packages/app-store/zoho-bigin/lib/CalendarService.ts:85-94."
    },
    {
      "bug_id": 8,
      "original_description": "refreshOAuthTokens returns fetch Response when sync enabled, but callers expect token object",
      "file": "packages/app-store/_utils/oauth/refreshOAuthTokens.ts",
      "line": 12,
      "original_severity": "medium",
      "original_source": "golden_only",
      "verdict": "confirmed",
      "verified_file": "packages/app-store/_utils/oauth/refreshOAuthTokens.ts",
      "verified_line": 15,
      "verified_severity": "high",
      "verified_bug_type": "runtime_error",
      "verified_description": "When sync is enabled, refreshOAuthTokens returns the raw fetch Response; many callers treat the return value like an axios response/object with .data, causing undefined access and runtime errors.",
      "notes": "Verified at packages/app-store/_utils/oauth/refreshOAuthTokens.ts:8-19 (returns fetch Response)."
    },
    {
      "bug_id": 9,
      "original_description": "GoogleCalendarService res?.data is undefined when sync endpoint used (Response has no .data)",
      "file": "packages/app-store/googlecalendar/lib/CalendarService.ts",
      "line": 92,
      "original_severity": "medium",
      "original_source": "golden_only",
      "verdict": "confirmed",
      "verified_file": "packages/app-store/googlecalendar/lib/CalendarService.ts",
      "verified_line": 94,
      "verified_severity": "high",
      "verified_bug_type": "runtime_error",
      "verified_description": "GoogleCalendarService assumes refreshOAuthTokens returns an object with .data; under sync mode it returns a fetch Response so res?.data is undefined and token.access_token/token.expiry_date access will throw.",
      "notes": "Verified at packages/app-store/googlecalendar/lib/CalendarService.ts:88-96."
    }
  ],
  "false_positive_verdicts": [],
  "newly_discovered_bugs": []
}

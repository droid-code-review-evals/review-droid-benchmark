{
  "pr_number": 2,
  "pr_title": "feat: 2fa backup codes",
  "revalidation_date": "2026-01-20",
  "bug_verdicts": [
    {
      "bug_id": 1,
      "original_description": "TwoFactorAuthAPI.disable() signature breaking change - security/DisableTwoFactorModal.tsx still uses 2 args",
      "file": "apps/web/components/security/DisableTwoFactorModal.tsx",
      "line": 38,
      "original_severity": "high",
      "original_source": "droid",
      "verdict": "rejected",
      "verified_file": "apps/web/components/security/DisableTwoFactorModal.tsx",
      "verified_line": 38,
      "verified_severity": "low",
      "verified_bug_type": "unknown",
      "verified_description": "Not a bug: this component imports apps/web/components/security/TwoFactorAuthAPI.ts where disable(password, code) accepts 2 args, and the /api/auth/two-factor/totp/disable endpoint supports TOTP-only requests via req.body.code.",
      "notes": "The PR adds backup-code support elsewhere (settings modal + next-auth). The security/ TwoFactorAuthAPI is separate and still matches its call site."
    },
    {
      "bug_id": 2,
      "original_description": "Inconsistent naming: BackupCode.tsx exports function named TwoFactor",
      "file": "apps/web/components/auth/BackupCode.tsx",
      "line": 7,
      "original_severity": "low",
      "original_source": "golden",
      "verdict": "rejected",
      "verified_file": "apps/web/components/auth/BackupCode.tsx",
      "verified_line": 7,
      "verified_severity": "low",
      "verified_bug_type": "unknown",
      "verified_description": "Not a functional bug: the function name of a default export does not affect imports/usages.",
      "notes": "This is a readability/style issue (component name mismatch) but does not create incorrect behavior."
    },
    {
      "bug_id": 3,
      "original_description": "Misleading error message says 'login' in disable endpoint",
      "file": "apps/web/pages/api/auth/two-factor/totp/disable.ts",
      "line": 48,
      "original_severity": "low",
      "original_source": "golden",
      "verdict": "modified",
      "verified_file": "apps/web/pages/api/auth/two-factor/totp/disable.ts",
      "verified_line": 50,
      "verified_severity": "low",
      "verified_bug_type": "documentation",
      "verified_description": "In the disable endpoint, the missing-encryption-key log message says 'backup code login', which is misleading in this disable flow.",
      "notes": "Verified at disable.ts:50. Functional behavior is unaffected; this is a misleading log/error message." 
    },
    {
      "bug_id": 4,
      "original_description": "Case-sensitive backup code validation (login flow)",
      "file": "packages/features/auth/lib/next-auth-options.ts",
      "line": 130,
      "original_severity": "medium",
      "original_source": "golden",
      "verdict": "modified",
      "verified_file": "packages/features/auth/lib/next-auth-options.ts",
      "verified_line": 144,
      "verified_severity": "medium",
      "verified_bug_type": "logic_bug",
      "verified_description": "Backup-code validation uses an exact indexOf match on credentials.backupCode with only '-' stripped; if users enter A-F in a different case (or otherwise normalized differently), the code will be rejected even if it should be treated case-insensitively.",
      "notes": "Verified at next-auth-options.ts:144. Backup codes are generated via .toString('hex') (lowercase), so uppercase user input would fail." 
    },
    {
      "bug_id": 5,
      "original_description": "Case-sensitive backup code validation (disable flow)",
      "file": "apps/web/pages/api/auth/two-factor/totp/disable.ts",
      "line": 57,
      "original_severity": "medium",
      "original_source": "golden",
      "verdict": "modified",
      "verified_file": "apps/web/pages/api/auth/two-factor/totp/disable.ts",
      "verified_line": 61,
      "verified_severity": "medium",
      "verified_bug_type": "logic_bug",
      "verified_description": "Backup-code validation in the disable endpoint uses an exact indexOf match on req.body.backupCode with only '-' stripped; users entering hex letters with different casing can be rejected unexpectedly.",
      "notes": "Verified at disable.ts:61. Same normalization issue as the login flow." 
    },
    {
      "bug_id": 6,
      "original_description": "Race condition: concurrent backup code use can bypass one-time-use semantics",
      "file": "packages/features/auth/lib/next-auth-options.ts",
      "line": 127,
      "original_severity": "high",
      "original_source": "golden",
      "verdict": "modified",
      "verified_file": "packages/features/auth/lib/next-auth-options.ts",
      "verified_line": 148,
      "verified_severity": "high",
      "verified_bug_type": "race_condition",
      "verified_description": "Backup code consumption is non-atomic: concurrent authorize() calls can both decrypt the same backupCodes list, both find the same code, and both update the user record, allowing a single backup code to be used more than once.",
      "notes": "Verified around next-auth-options.ts:144-154. The read/validate/write is not guarded by a transaction or conditional update on the specific code." 
    }
  ],
  "false_positive_verdicts": [],
  "newly_discovered_bugs": []
}

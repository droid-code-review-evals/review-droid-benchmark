{
  "pr_number": 10,
  "pr_title": "FEATURE: Can edit category/host relationships for embedding",
  "revalidation_date": "2026-01-20",
  "bug_verdicts": [
    {
      "bug_id": 1,
      "original_description": "Migration crashes when embed_category site setting is unset - accessing [0]['id'] on empty result",
      "file": "db/migrate/20150818190757_create_embeddable_hosts.rb",
      "line": 11,
      "original_severity": "medium",
      "original_source": "droid",
      "verdict": "confirmed",
      "verified_file": "db/migrate/20150818190757_create_embeddable_hosts.rb",
      "verified_line": 11,
      "verified_severity": "medium",
      "verified_bug_type": "runtime_error",
      "verified_description": "Migration assumes the embed_category lookup returns at least one row; when it doesn't, execute(...)[0] is nil and ['id'] raises (NoMethodError/TypeError depending on adapter).",
      "notes": "execute(...) can return an empty result set; indexing [0] then accessing ['id'] is unsafe without a cmd_tuples/any? guard."
    },
    {
      "bug_id": 2,
      "original_description": "SQL injection/breakage in migration INSERT - unquoted string interpolation",
      "file": "db/migrate/20150818190757_create_embeddable_hosts.rb",
      "line": 25,
      "original_severity": "medium",
      "original_source": "droid",
      "verdict": "confirmed",
      "verified_file": "db/migrate/20150818190757_create_embeddable_hosts.rb",
      "verified_line": 25,
      "verified_severity": "medium",
      "verified_bug_type": "security",
      "verified_description": "Migration builds raw SQL with host value interpolated into a quoted string; a host containing a quote can break the statement and can be used for SQL injection.",
      "notes": "Host strings come from the embeddable_hosts site setting; at minimum this is a reliability issue (syntax error) and potentially an injection vector."
    },
    {
      "bug_id": 3,
      "original_description": "Fabricator files swapped - category_fabricator.rb defines embeddable_host, breaking all category specs",
      "file": "spec/fabricators/category_fabricator.rb",
      "line": 1,
      "original_severity": "medium",
      "original_source": "droid",
      "verdict": "confirmed",
      "verified_file": "spec/fabricators/category_fabricator.rb",
      "verified_line": 1,
      "verified_severity": "medium",
      "verified_bug_type": "logic_bug",
      "verified_description": "The fabricator definitions are swapped: category_fabricator.rb defines Fabricator(:embeddable_host) while embeddable_host_fabricator.rb defines Fabricator(:category), so callers of Fabricator(:category) via the expected file fail or build the wrong model.",
      "notes": "Verified by inspecting both spec/fabricators/category_fabricator.rb and spec/fabricators/embeddable_host_fabricator.rb."
    },
    {
      "bug_id": 4,
      "original_description": "_ids hydration deletes original IDs even when lookups return null, inconsistent with singular behavior",
      "file": "app/assets/javascripts/discourse/models/store.js.es6",
      "line": 198,
      "original_severity": "medium",
      "original_source": "droid",
      "verdict": "modified",
      "verified_file": "app/assets/javascripts/discourse/models/store.js.es6",
      "verified_line": 201,
      "verified_severity": "medium",
      "verified_bug_type": "logic_bug",
      "verified_description": "In _hydrateEmbedded, the plural *_ids branch always deletes the original ids key after mapping, even if some ids could not be resolved (yielding undefined entries). The singular *_id branch only deletes when hydration succeeds, so behavior is inconsistent and information is lost.",
      "notes": "Adjusted verified_line to the unconditional delete (line 201) which is the core of the issue; original line 198 is within the same block."
    },
    {
      "bug_id": 5,
      "original_description": "NoMethodError in before_validation - host.sub! called when host is nil",
      "file": "app/models/embeddable_host.rb",
      "line": 6,
      "original_severity": "medium",
      "original_source": "golden",
      "verdict": "confirmed",
      "verified_file": "app/models/embeddable_host.rb",
      "verified_line": 6,
      "verified_severity": "medium",
      "verified_bug_type": "runtime_error",
      "verified_description": "before_validation unconditionally calls sub! on self.host; if host is nil (e.g., missing/blank params), validations trigger a NoMethodError before errors can be added.",
      "notes": "Model validates format but does not guard nil before running the callback."
    },
    {
      "bug_id": 6,
      "original_description": "Update and destroy methods don't check for nil after .first, causing NoMethodError on missing record",
      "file": "app/controllers/admin/embeddable_hosts_controller.rb",
      "line": 10,
      "original_severity": "medium",
      "original_source": "golden",
      "verdict": "confirmed",
      "verified_file": "app/controllers/admin/embeddable_hosts_controller.rb",
      "verified_line": 10,
      "verified_severity": "medium",
      "verified_bug_type": "runtime_error",
      "verified_description": "update/destroy use where(...).first without handling the not-found case; update passes nil into save_host and destroy calls host.destroy on nil, both causing NoMethodError.",
      "notes": "A missing/invalid :id leads to a 500 instead of a controlled 404/JSON error."
    },
    {
      "bug_id": 7,
      "original_description": "record_for_host case sensitivity bug - SQL lower() on column but not on parameter",
      "file": "app/models/embeddable_host.rb",
      "line": 17,
      "original_severity": "medium",
      "original_source": "golden",
      "verdict": "confirmed",
      "verified_file": "app/models/embeddable_host.rb",
      "verified_line": 17,
      "verified_severity": "medium",
      "verified_bug_type": "logic_bug",
      "verified_description": "record_for_host queries lower(host) = ? but passes the raw host parameter; if the stored host includes uppercase characters, the lookup may fail because the RHS isn't downcased.",
      "notes": "Fix would be to downcase the parameter or use lower(?) in SQL."
    },
    {
      "bug_id": 8,
      "original_description": "Migration doesn't normalize hosts - migrated data with http:// or paths won't match lookups",
      "file": "db/migrate/20150818190757_create_embeddable_hosts.rb",
      "line": 25,
      "original_severity": "medium",
      "original_source": "golden",
      "verdict": "confirmed",
      "verified_file": "db/migrate/20150818190757_create_embeddable_hosts.rb",
      "verified_line": 25,
      "verified_severity": "medium",
      "verified_bug_type": "logic_bug",
      "verified_description": "Migration inserts hosts directly via SQL, bypassing EmbeddableHost's before_validation normalization that strips protocol/path; records migrated with http(s):// or paths can be stored unnormalized and later fail to match record_for_host (which uses uri.host).",
      "notes": "Verified: normalization exists only in the model callback; migration uses INSERT ... VALUES ('#{h}', ...) without stripping protocol/path."
    }
  ],
  "false_positive_verdicts": [],
  "newly_discovered_bugs": []
}

{
  "pr_number": 6,
  "pr_title": "Dual Storage Architecture",
  "revalidation_date": "2026-01-20",
  "bug_verdicts": [
    {
      "bug_id": 1,
      "original_description": "Context/log propagation bug in Delete - uses d.Log instead of enriched log variable",
      "file": "pkg/apiserver/rest/dualwriter_mode3.go",
      "line": 98,
      "original_severity": "medium",
      "original_source": "both",
      "verdict": "modified",
      "verified_file": "pkg/apiserver/rest/dualwriter_mode3.go",
      "verified_line": 97,
      "verified_severity": "medium",
      "verified_bug_type": "logic_bug",
      "verified_description": "DualWriterMode3.Delete builds an enriched logger (with name/kind/method) but attaches ctx to the base d.Log instead, so downstream storage/legacy calls that derive logging from context lose those request-specific fields.",
      "notes": "Confirmed: Delete() does `log := d.Log.WithValues(...)` but then uses `ctx = klog.NewContext(ctx, d.Log)` at line 97. The draft line is off by +1."
    },
    {
      "bug_id": 2,
      "original_description": "DeleteCollection goroutine uses recordStorageDuration instead of recordLegacyDuration",
      "file": "pkg/apiserver/rest/dualwriter_mode3.go",
      "line": 166,
      "original_severity": "medium",
      "original_source": "droid_only",
      "verdict": "confirmed",
      "verified_file": "pkg/apiserver/rest/dualwriter_mode3.go",
      "verified_line": 166,
      "verified_severity": "medium",
      "verified_bug_type": "logic_bug",
      "verified_description": "DualWriterMode3.DeleteCollection measures legacy delete duration (startLegacy) but records it into the storage duration histogram via recordStorageDuration, polluting storage metrics and leaving legacy duration unreported.",
      "notes": "Confirmed at dualwriter_mode3.go:161-167: the legacy DeleteCollection goroutine calls d.recordStorageDuration(..., startLegacy) instead of d.recordLegacyDuration."
    },
    {
      "bug_id": 3,
      "original_description": "Create failure calls recordLegacyDuration instead of recordStorageDuration",
      "file": "pkg/apiserver/rest/dualwriter_mode3.go",
      "line": 45,
      "original_severity": "medium",
      "original_source": "both",
      "verdict": "confirmed",
      "verified_file": "pkg/apiserver/rest/dualwriter_mode3.go",
      "verified_line": 45,
      "verified_severity": "medium",
      "verified_bug_type": "logic_bug",
      "verified_description": "On storage Create() failure, DualWriterMode3 records the duration into the legacy duration histogram (recordLegacyDuration) even though the timed operation was storage.Create, misreporting metrics.",
      "notes": "Confirmed at dualwriter_mode3.go:41-47: startStorage is recorded via recordLegacyDuration on the storage error path."
    },
    {
      "bug_id": 4,
      "original_description": "Update failure calls recordLegacyDuration instead of recordStorageDuration",
      "file": "pkg/apiserver/rest/dualwriter_mode3.go",
      "line": 129,
      "original_severity": "medium",
      "original_source": "both",
      "verdict": "confirmed",
      "verified_file": "pkg/apiserver/rest/dualwriter_mode3.go",
      "verified_line": 129,
      "verified_severity": "medium",
      "verified_bug_type": "logic_bug",
      "verified_description": "On storage Update() failure, DualWriterMode3 records the duration into the legacy duration histogram (recordLegacyDuration) instead of the storage duration histogram.",
      "notes": "Confirmed at dualwriter_mode3.go:125-131: startStorage is recorded via recordLegacyDuration on the storage error path."
    },
    {
      "bug_id": 5,
      "original_description": "Delete success uses name instead of options.Kind for metric label (cardinality explosion)",
      "file": "pkg/apiserver/rest/dualwriter_mode3.go",
      "line": 106,
      "original_severity": "medium",
      "original_source": "both",
      "verdict": "modified",
      "verified_file": "pkg/apiserver/rest/dualwriter_mode3.go",
      "verified_line": 106,
      "verified_severity": "high",
      "verified_bug_type": "performance",
      "verified_description": "On successful Delete(), DualWriterMode3 records storage duration with the object's name in the \"kind\" label position, causing unbounded label cardinality in the prometheus histogram (potentially one time series per object name).",
      "notes": "Confirmed at dualwriter_mode3.go:106: d.recordStorageDuration(false, mode3Str, name, method, startStorage) should pass options.Kind (as other modes do) to keep label cardinality bounded. Severity upgraded due to high-cardinality metrics risk."
    }
  ],
  "false_positive_verdicts": [],
  "newly_discovered_bugs": []
}

{
  "pr_number": 7,
  "pr_title": "Optimize spans buffer insertion with eviction during insert",
  "revalidation_date": "2026-01-20",
  "bug_verdicts": [
    {
      "bug_id": 1,
      "original_description": "end_timestamp_precise KeyError in process_batch",
      "file": "src/sentry/spans/consumers/process/factory.py",
      "line": 141,
      "original_severity": "medium",
      "original_source": "droid_only",
      "verdict": "modified",
      "verified_file": "src/sentry/spans/consumers/process/factory.py",
      "verified_line": 141,
      "verified_severity": "high",
      "verified_bug_type": "runtime_error",
      "verified_description": "process_batch indexes val['end_timestamp_precise'] from the ingested span payload; if the key is missing for any event variant/backfill, the consumer raises KeyError and drops/crashes the batch.",
      "notes": "PR adds end_timestamp_precise to Span and unconditionally reads it from the decoded JSON (val[...])."
    },
    {
      "bug_id": 2,
      "original_description": "organization_context.member None AttributeError",
      "file": "src/sentry/api/endpoints/organization_auditlogs.py",
      "line": 70,
      "original_severity": "medium",
      "original_source": "droid_only",
      "verdict": "modified",
      "verified_file": "src/sentry/api/endpoints/organization_auditlogs.py",
      "verified_line": 71,
      "verified_severity": "high",
      "verified_bug_type": "runtime_error",
      "verified_description": "organization_context.member is declared as Optional and can be None; accessing organization_context.member.has_global_access will raise AttributeError for contexts without membership.",
      "notes": "RpcUserOrganizationContext.member is RpcOrganizationMember | None (src/sentry/organizations/services/organization/model.py). Line shifted to 71 on PR branch."
    },
    {
      "bug_id": 3,
      "original_description": "BasePaginator negative slicing AssertionError",
      "file": "src/sentry/api/paginator.py",
      "line": 182,
      "original_severity": "medium",
      "original_source": "both",
      "verdict": "confirmed",
      "verified_file": "src/sentry/api/paginator.py",
      "verified_line": 184,
      "verified_severity": "medium",
      "verified_bug_type": "runtime_error",
      "verified_description": "BasePaginator.get_result can pass a negative start_offset into a Django QuerySet slice (queryset[start:stop]) when cursor.is_prev and cursor.offset is negative, which triggers Django's 'Negative indexing is not supported' AssertionError.",
      "notes": "Cursor.from_string accepts negative offsets; PR explicitly enables negative offsets but Django ORM slicing does not support them."
    },
    {
      "bug_id": 4,
      "original_description": "OptimizedCursorPaginator negative slicing AssertionError",
      "file": "src/sentry/api/paginator.py",
      "line": 883,
      "original_severity": "medium",
      "original_source": "both",
      "verdict": "confirmed",
      "verified_file": "src/sentry/api/paginator.py",
      "verified_line": 882,
      "verified_severity": "medium",
      "verified_bug_type": "runtime_error",
      "verified_description": "OptimizedCursorPaginator.get_result explicitly sets start_offset=cursor.offset for negative offsets when enable_advanced_features is on; slicing a Django QuerySet with a negative start will raise AssertionError.",
      "notes": "The code comment claims Django handles negative slicing automatically, but it does not."
    },
    {
      "bug_id": 5,
      "original_description": "ZUNIONSTORE score corruption (default SUM corrupts timestamps)",
      "file": "src/sentry/scripts/spans/add-buffer.lua",
      "line": 47,
      "original_severity": "medium",
      "original_source": "droid_only",
      "verdict": "confirmed",
      "verified_file": "src/sentry/scripts/spans/add-buffer.lua",
      "verified_line": 47,
      "verified_severity": "medium",
      "verified_bug_type": "data_corruption",
      "verified_description": "The Lua script merges ZSETs via ZUNIONSTORE without specifying AGGREGATE; Redis defaults to SUM, so if any member exists in both inputs its timestamp score will be summed/corrupted, breaking ordering/eviction semantics.",
      "notes": "Occurs at both union calls (lines 47 and 53); should use an aggregate like MAX/MIN depending on intended semantics."
    },
    {
      "bug_id": 6,
      "original_description": "SET to ZSET WRONGTYPE during migration",
      "file": "src/sentry/spans/buffer.py",
      "line": 197,
      "original_severity": "medium",
      "original_source": "droid_only",
      "verdict": "modified",
      "verified_file": "src/sentry/spans/buffer.py",
      "verified_line": 197,
      "verified_severity": "high",
      "verified_bug_type": "runtime_error",
      "verified_description": "This PR migrates span buffer storage from Redis SETs (SADD/SCARD/SUNIONSTORE) to ZSETs (ZADD/ZCARD/ZUNIONSTORE). Existing keys created by the previous version will be type SET, so ZADD/ZUNIONSTORE on them will raise WRONGTYPE until those keys expire/are cleared.",
      "notes": "Diff shows p.sadd -> p.zadd and SUNIONSTORE -> ZUNIONSTORE (with eviction). Without an explicit migration/cleanup, mixed deployments will error."
    },
    {
      "bug_id": 7,
      "original_description": "OptimizedCursorPaginator.get_item_key datetime TypeError",
      "file": "src/sentry/api/paginator.py",
      "line": 839,
      "original_severity": "medium",
      "original_source": "golden_only",
      "verdict": "confirmed",
      "verified_file": "src/sentry/api/paginator.py",
      "verified_line": 838,
      "verified_severity": "medium",
      "verified_bug_type": "runtime_error",
      "verified_description": "OptimizedCursorPaginator.get_item_key applies math.floor/ceil to the order_by field value; when the paginator is used with a datetime sort key (e.g. order_by='-datetime'), math.floor(datetime) raises TypeError.",
      "notes": "organization_auditlogs switches to OptimizedCursorPaginator with order_by='-datetime' under optimized_pagination, making this a reachable crash for that path."
    }
  ],
  "false_positive_verdicts": [],
  "newly_discovered_bugs": []
}
